<!DOCTYPE html>
<html lang="pt-br">
<head>
    <!-- PWA Configuration -->
<link rel="manifest" href="pwa/manifest.json">
<meta name="theme-color" content="#212121">

<!-- iOS PWA Support -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Venda+ Adm">
<link rel="apple-touch-icon" href="favicon.ico">

<!-- Android PWA Support -->
<meta name="mobile-web-app-capable" content="yes">

<!-- PWA Install Prompt -->
<meta name="application-name" content="Venda+ Adm">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login | Adm</title>
    <script>
(function () {
    try {
        const raw = localStorage.getItem('adminSession');
        if (!raw) {
            location.replace('login.html');
            return;
        }

        const data = JSON.parse(raw);
        if (!data.timestamp) {
            localStorage.removeItem('adminSession');
            location.replace('login.html');
            return;
        }

        const timestamp = new Date(data.timestamp).getTime();
        if (!timestamp) {
            localStorage.removeItem('adminSession');
            location.replace('login.html');
            return;
        }

        const maxAge = 8 * 60 * 60 * 1000;
        if (Date.now() - timestamp <= maxAge) {
            // Redireciona DIRETAMENTE para paineladm.html se já logado
            location.replace('paineladm.html');
        } else {
            localStorage.removeItem('adminSession');
            location.replace('login.html');
        }

    } catch {
        location.replace('login.html');
    }
})();
    </script>
</head>
<body>
    <p>Redirecionando...</p>
    <script>
// ========== PWA INSTALLATION HANDLER ==========
let deferredPrompt;
const installButton = document.createElement('button');

// Detecta quando o app pode ser instalado
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  
  // Mostra botão de instalação se não estiver já instalado
  if (!window.matchMedia('(display-mode: standalone)').matches) {
    showInstallPromotion();
  }
});

// Quando o app é instalado
window.addEventListener('appinstalled', () => {
  console.log('PWA instalado com sucesso!');
  deferredPrompt = null;
  
  // Remove o botão de instalação
  if (installButton.parentNode) {
    installButton.parentNode.removeChild(installButton);
  }
  
  // Atualiza analytics ou estatísticas
  logEvent('pwa_installed');
});

// Mostra promoção de instalação
function showInstallPromotion() {
  installButton.innerHTML = '<i class="fas fa-download"></i> Instalar App';
  installButton.style.cssText = `
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--primary-color);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 25px;
    font-weight: 600;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    cursor: pointer;
    z-index: 10000;
    display: flex;
    align-items: center;
    gap: 8px;
    animation: slideUp 0.3s ease;
  `;
  
  installButton.onclick = installPWA;
  document.body.appendChild(installButton);
  
  // Remove automaticamente após 30 segundos
  setTimeout(() => {
    if (installButton.parentNode) {
      installButton.style.opacity = '0';
      setTimeout(() => {
        if (installButton.parentNode) {
          installButton.parentNode.removeChild(installButton);
        }
      }, 300);
    }
  }, 30000);
}

// Instala o PWA
function installPWA() {
  if (!deferredPrompt) return;
  
  deferredPrompt.prompt();
  
  deferredPrompt.userChoice.then((choiceResult) => {
    if (choiceResult.outcome === 'accepted') {
      console.log('Usuário aceitou instalação');
    } else {
      console.log('Usuário recusou instalação');
    }
    deferredPrompt = null;
  });
}

// ========== SERVICE WORKER REGISTRATION ==========
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    const swUrl = 'pwa/sw.js';
    
    navigator.serviceWorker.register(swUrl)
      .then(registration => {
        console.log('Service Worker registrado:', registration);
        
        // Verifica atualizações periodicamente
        setInterval(() => {
          registration.update();
        }, 60 * 60 * 1000); // A cada hora
        
        // Escuta por nova versão
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          console.log('Nova versão do Service Worker encontrada');
          
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              console.log('Nova versão disponível!');
              showUpdateNotification();
            }
          });
        });
      })
      .catch(error => {
        console.error('Erro no Service Worker:', error);
      });
  });
}

// Mostra notificação de atualização
function showUpdateNotification() {
  if (Notification.permission === 'granted') {
    new Notification('Nova versão disponível!', {
      body: 'Clique para atualizar o aplicativo',
      icon: 'favicon.ico',
      tag: 'update-available'
    }).onclick = () => {
      window.location.reload();
    };
  }
}

// ========== PWA UTILITIES ==========
function logEvent(eventName, data = {}) {
  // Implemente seu próprio logging (Firebase Analytics, etc.)
  console.log(`[PWA Event] ${eventName}:`, data);
}

// Verifica se está rodando como PWA
function isRunningAsPWA() {
  return window.matchMedia('(display-mode: standalone)').matches || 
         window.navigator.standalone ||
         document.referrer.includes('android-app://');
}

// Detecta modo de display
if (isRunningAsPWA()) {
  console.log('Rodando como PWA instalado');
  document.documentElement.classList.add('pwa-mode');
  
  // Otimizações para PWA
  if ('connection' in navigator && navigator.connection.saveData === true) {
    console.log('Modo dados economizados ativado');
  }
} else {
  console.log('Rodando no navegador');
}

// ========== OFFLINE DETECTION ==========
function updateOnlineStatus() {
  const status = navigator.onLine ? 'online' : 'offline';
  document.documentElement.setAttribute('data-network', status);
  
  // Mostra notificação de status
  if (status === 'offline') {
    showOfflineNotification();
  }
}

window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);
updateOnlineStatus();

function showOfflineNotification() {
  const notification = document.createElement('div');
  notification.innerHTML = '<i class="fas fa-wifi-slash"></i> Modo offline';
  notification.style.cssText = `
    position: fixed;
    top: 10px;
    right: 10px;
    background: var(--warning-color);
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 8px;
    z-index: 10000;
    animation: slideInRight 0.3s ease;
  `;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.opacity = '0';
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 300);
  }, 3000);
}
</script>
</body>
</html>
