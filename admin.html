<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tecminia</title>
    <link rel="icon" href="favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/imask/6.4.3/imask.min.js"></script>
    
    <!-- META TAGS PARA PREVENIR DETEC√á√ÉO DE TELEFONE -->
    <meta name="format-detection" content="telephone=no">
    <meta name="format-detection" content="date=no">
    <meta name="format-detection" content="address=no">
    <meta name="format-detection" content="email=no">
    
    <style>
        :root {
            --primary-color: #212121;
            --secondary-color: #424242;
            --success-color: #4CAF50;
            --warning-color: #FF9800;
            --danger-color: #F44336;
            --info-color: #2196F3;
            --light-bg: #f5f5f5;
            --card-bg: #ffffff;
            --border-color: #e0e0e0;
            --text-primary: #212121;
            --text-secondary: #757575;
            --shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
        }
        
        html, body {
            height: 100%;
            overflow: hidden;
            background: var(--light-bg);
            color: var(--text-primary);
        }
        
        body {
            font-size: 14px;
            padding: 0;
            display: flex;
            flex-direction: column;
        }
        
        /* Prevenir sele√ß√£o de texto n√£o edit√°vel */
        .admin-header,
        .stats-grid,
        .stat-card,
        .tab-navigation,
        .tab-btn,
        .list-item,
        .item-header,
        .item-title,
        .item-subtitle,
        .status-badge,
        .settings-section,
        .section-title,
        .form-input[readonly],
        .form-input:not(input):not(textarea),
        .modal-title,
        .empty-state,
        .empty-title,
        .empty-text,
        .loading-text,
        .notification {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* Permitir sele√ß√£o apenas em campos edit√°veis */
        input, textarea {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        
        /* Status Bar */
        .status-bar {
            height: env(safe-area-inset-top, 0px);
            background: var(--primary-color);
        }
        
        /* Admin Container */
        .admin-container {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        /* Header - Native Style */
        .admin-header {
            background: var(--primary-color);
            color: white;
            padding: 12px 16px;
            box-shadow: var(--shadow);
            z-index: 100;
            flex-shrink: 0;
        }
        
        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        .header-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }
        
        .header-text h1 {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .header-text p {
            font-size: 0.75rem;
            opacity: 0.8;
        }
        
        .header-actions {
            display: flex;
            gap: 8px;
        }
        
        .icon-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .icon-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        /* Stats Grid - Native Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            padding: 12px 16px;
            background: white;
            flex-shrink: 0;
        }
        
        .stat-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }
        
        .stat-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        .stat-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }
        
        .stat-icon.total { background: rgba(33, 150, 243, 0.1); color: var(--info-color); }
        .stat-icon.active { background: rgba(76, 175, 80, 0.1); color: var(--success-color); }
        .stat-icon.pending { background: rgba(255, 152, 0, 0.1); color: var(--warning-color); }
        .stat-icon.blocked { background: rgba(244, 67, 54, 0.1); color: var(--danger-color); }
        .stat-icon.expired { background: rgba(96, 125, 139, 0.1); color: #607d8b; }
        .stat-icon.revenue { background: rgba(156, 39, 176, 0.1); color: #9c27b0; }
        
        .stat-number {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        /* Tab Navigation - Native */
        .tab-navigation {
            display: flex;
            background: white;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
            padding: 0 16px;
        }
        
        .tab-btn {
            flex: 1;
            padding: 14px 0;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.9rem;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
        }
        
        .tab-btn.active {
            color: var(--primary-color);
        }
        
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-color);
            border-radius: 3px 3px 0 0;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        
        .tab-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 16px;
            display: none;
            background: var(--light-bg);
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Search Bar - Native */
        .search-bar {
            margin-bottom: 16px;
        }
        
        .search-container {
            background: white;
            border-radius: 10px;
            padding: 0 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
        }
        
        .search-container i {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .search-container input {
            flex: 1;
            padding: 12px 0;
            border: none;
            outline: none;
            font-size: 0.9rem;
            background: transparent;
        }
        
        /* List Items - Native */
        .list-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .list-item {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }
        
        .list-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .item-title {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .item-subtitle {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 2px;
        }
        
        .item-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .detail-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .detail-value {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        /* Status Badges */
        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
            text-align: center;
        }
        
        .status-active { background: rgba(76, 175, 80, 0.1); color: var(--success-color); }
        .status-pending { background: rgba(255, 152, 0, 0.1); color: var(--warning-color); }
        .status-blocked { background: rgba(244, 67, 54, 0.1); color: var(--danger-color); }
        .status-expired { background: rgba(96, 125, 139, 0.1); color: #607d8b; }
        .status-approved { background: rgba(76, 175, 80, 0.1); color: var(--success-color); }
        .status-rejected { background: rgba(244, 67, 54, 0.1); color: var(--danger-color); }
        
        /* Action Buttons */
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        
        .action-btn {
            padding: 10px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .btn-view { background: rgba(33, 150, 243, 0.1); color: var(--info-color); }
        .btn-activate { background: rgba(76, 175, 80, 0.1); color: var(--success-color); }
        .btn-block { background: rgba(244, 67, 54, 0.1); color: var(--danger-color); }
        .btn-approve { background: rgba(76, 175, 80, 0.1); color: var(--success-color); }
        .btn-reject { background: rgba(244, 67, 54, 0.1); color: var(--danger-color); }
        .btn-delete { background: rgba(33, 33, 33, 0.1); color: var(--primary-color); }
        .btn-whatsapp { background: rgba(37, 211, 102, 0.1); color: #25D366; }
        
        .action-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        /* Settings Form */
        .settings-section {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }
        
        .section-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--primary-color);
            color: var(--text-primary);
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.85rem;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            background: white;
            color: var(--text-primary);
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(33, 33, 33, 0.1);
        }
        
        .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.9rem;
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }
        
        .form-hint {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 4px;
            display: block;
        }
        
        /* Submit Button */
        .submit-btn {
            width: 100%;
            padding: 14px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .submit-btn:hover {
            background: #000;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        
        .empty-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            color: #e0e0e0;
        }
        
        .empty-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }
        
        .empty-text {
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s ease;
            outline: none;
            -webkit-tap-highlight-color: transparent;
            box-shadow: none;
        }

        .fab:hover,
        .fab:active,
        .fab:focus {
            box-shadow: none;
            transform: scale(1.05);
            background: #000;
            outline: none;
        }
        
        /* Modals - Native Style */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.3s ease;
        }
        
        .modal-header {
            padding: 20px 20px 12px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            line-height: 1;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        /* Confirmation Modal */
        .confirmation-text {
            padding: 12px;
            border: 2px solid var(--danger-color);
            border-radius: 8px;
            background: rgba(244, 67, 54, 0.05);
            margin-bottom: 20px;
            font-size: 0.9rem;
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 16px;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .loading-text {
            color: white;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 16px 24px;
            border-radius: 12px;
            background: var(--primary-color);
            color: white;
            font-weight: 500;
            text-align: center;
            z-index: 4000;
            animation: fadeIn 0.3s ease;
            max-width: 280px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .notification.success { background: var(--success-color); }
        .notification.error { background: var(--danger-color); }
        .notification.info { background: var(--info-color); }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Utilities */
        .mt-1 { margin-top: 8px; }
        .mt-2 { margin-top: 16px; }
        .mb-1 { margin-bottom: 8px; }
        .mb-2 { margin-bottom: 16px; }
        .text-center { text-align: center; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 8px; }
        
        @media (max-width: 360px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Status Bar -->
    <div class="status-bar"></div>
    
    <!-- Admin Container -->
    <div class="admin-container">
        <!-- Header -->
        <header class="admin-header">
            <div class="header-top">
                <div class="header-title">
                    <div class="header-icon">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <div class="header-text">
                        <h1>Admin Venda+</h1>
                        <p>Painel de Controle</p>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="icon-btn" id="refreshBtn" title="Atualizar">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="icon-btn" id="logoutBtn" title="Sair">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Stats Grid -->
        <div class="stats-grid" id="statsGrid">
            <!-- Stats will be loaded here -->
        </div>
        
        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-btn active" data-tab="users">
                <i class="fas fa-users"></i> Usu√°rios
            </button>
            <button class="tab-btn" data-tab="payments">
                <i class="fas fa-money-bill"></i> Pagamentos
            </button>
            <button class="tab-btn" data-tab="settings">
                <i class="fas fa-cog"></i> Configura√ß√µes
            </button>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Users Tab -->
            <div id="usersTab" class="tab-content active">
                <div class="search-bar">
                    <div class="search-container">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchUsers" placeholder="Buscar usu√°rios...">
                    </div>
                </div>
                
                <div class="list-container" id="usersList">
                    <!-- Users will be loaded here -->
                </div>
                
                <div class="empty-state" id="usersEmpty" style="display: none;">
                    <div class="empty-icon">
                        <i class="fas fa-users-slash"></i>
                    </div>
                    <div class="empty-title">Nenhum usu√°rio encontrado</div>
                    <div class="empty-text">Os usu√°rios cadastrados aparecer√£o aqui</div>
                </div>
            </div>
            
            <!-- Payments Tab -->
            <div id="paymentsTab" class="tab-content">
                <div class="search-bar">
                    <div class="search-container">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchPayments" placeholder="Buscar pagamentos...">
                    </div>
                </div>
                
                <div class="list-container" id="paymentsList">
                    <!-- Payments will be loaded here -->
                </div>
                
                <div class="empty-state" id="paymentsEmpty" style="display: none;">
                    <div class="empty-icon">
                        <i class="fas fa-file-invoice-dollar"></i>
                    </div>
                    <div class="empty-title">Nenhum pagamento encontrado</div>
                    <div class="empty-text">Os pagamentos aparecer√£o aqui</div>
                </div>
            </div>
            
            <!-- Settings Tab -->
            <div id="settingsTab" class="tab-content">
                <div class="settings-section">
                    <h2 class="section-title">Configura√ß√µes de Pagamento</h2>
                    
                    <form id="paymentSettingsForm">
                        <div class="form-group">
                            <label class="form-label">Chave PIX Padr√£o</label>
                            <input type="text" id="pixKey" class="form-input" placeholder="Chave PIX para recebimentos" required>
                            <span class="form-hint">Esta chave PIX ser√° exibida para todos os usu√°rios</span>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">WhatsApp para Notifica√ß√µes</label>
                            <input type="text" id="adminWhatsApp" class="form-input" placeholder="(11) 99999-9999" required>
                            <span class="form-hint">N√∫mero que receber√° notifica√ß√µes de novos pagamentos</span>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Valor do Plano Mensal (R$)</label>
                            <input type="number" id="monthlyPlanPrice" class="form-input" step="0.01" min="0" value="99.00" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Dias para Notifica√ß√£o de Vencimento</label>
                            <input type="number" id="expirationWarningDays" class="form-input" min="1" max="30" value="7" required>
                            <span class="form-hint">Dias antes do vencimento para notificar o usu√°rio</span>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Mensagem de Notifica√ß√£o WhatsApp</label>
                            <textarea id="whatsappMessage" class="form-textarea" rows="5">
üì± *NOVO PAGAMENTO PENDENTE* üì±

üë§ *Cliente:* {nome}
üè™ *Loja:* {loja}
üìß *E-mail:* {email}
üì± *Telefone:* {telefone}
üíµ *Plano:* Mensal
üí∞ *Valor:* R$ {valor}
üìÖ *Data:* {data}

‚ö†Ô∏è *Status:* Aguardando confirma√ß√£o

Por favor, acesse o painel administrativo para verificar o comprovante e liberar o acesso.
                            </textarea>
                            <span class="form-hint">Use {nome}, {loja}, {email}, {telefone}, {valor}, {data} como vari√°veis</span>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Mensagem de Pagamento Aprovado (para cliente)</label>
                            <textarea id="paymentApprovedMessage" class="form-textarea" rows="5">
‚úÖ *PAGAMENTO APROVADO!* ‚úÖ

Ol√° {nome}! üëã

Seu pagamento foi *APROVADO* com sucesso! üéâ

üè™ *Loja:* {loja}
üíµ *Plano:* {plano}
üìÖ *V√°lido at√©:* {validade}
üí∞ *Valor:* R$ {valor}

Agora voc√™ j√° pode acessar sua conta e come√ßar a usar todas as funcionalidades do Venda+!

üîó *Acesse:* https://seusite.com/login

Em caso de d√∫vidas, estamos √† disposi√ß√£o!

Atenciosamente,
Equipe Venda+ üì±
                            </textarea>
                            <span class="form-hint">Mensagem enviada ao cliente quando pagamento for aprovado</span>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Mensagem de Pagamento Rejeitado (para cliente)</label>
                            <textarea id="paymentRejectedMessage" class="form-textarea" rows="5">
‚ùå *PAGAMENTO REJEITADO* ‚ùå

Ol√° {nome},

Lamentamos informar que seu pagamento foi *REJEITADO*.

üè™ *Loja:* {loja}
üíµ *Plano:* {plano}
üí∞ *Valor:* R$ {valor}
üìÖ *Data:* {data}

üìã *Motivo:* Comprovante n√£o identificado ou informa√ß√µes inconsistentes.

üîç *O que fazer:*
1. Verifique se o comprovante est√° leg√≠vel
2. Confirme se os dados est√£o corretos
3. Envie novamente o comprovante

Para mais informa√ß√µes, entre em contato conosco.

Atenciosamente,
Equipe Venda+ üì±
                            </textarea>
                            <span class="form-hint">Mensagem enviada ao cliente quando pagamento for rejeitado</span>
                        </div>
                        
                        <button type="submit" class="submit-btn">
                            <i class="fas fa-save"></i> Salvar Configura√ß√µes
                        </button>
                    </form>
                </div>
                
                <div class="settings-section">
                    <h2 class="section-title">Sistema</h2>
                    
                    <div class="form-group">
                        <label class="form-label">Admin Logado</label>
                            <div class="form-input" style="background: #f8f9fa;">
                            <div id="adminInfo">
                                <!-- Admin info will be loaded here -->
                            </div>
                        </div>
                    </div>
                    
                    <button class="submit-btn" id="clearCacheBtn">
                        <i class="fas fa-trash"></i> Limpar Cache
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Floating Action Button -->
        <button class="fab" id="newUserBtn" title="Novo Usu√°rio">
            <i class="fas fa-user-plus"></i>
        </button>
    </div>
    
    <!-- User Details Modal -->
    <div class="modal" id="userDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Detalhes do Usu√°rio</h2>
                <button class="modal-close" id="closeUserModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="userDetailsContent">
                    <!-- User details will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Payment Details Modal -->
    <div class="modal" id="paymentDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Detalhes do Pagamento</h2>
                <button class="modal-close" id="closePaymentModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="paymentDetailsContent">
                    <!-- Payment details will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- New User Modal -->
    <div class="modal" id="newUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Novo Usu√°rio</h2>
                <button class="modal-close" id="closeNewUserModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="newUserForm">
                    <div class="form-group">
                        <label class="form-label">Nome da Loja *</label>
                        <input type="text" id="newStoreName" class="form-input" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">E-mail *</label>
                        <input type="email" id="newUserEmail" class="form-input" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Senha *</label>
                        <input type="password" id="newUserPassword" class="form-input" required minlength="6">
                        <span class="form-hint">M√≠nimo 6 caracteres</span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Telefone (WhatsApp) *</label>
                        <input type="text" id="newUserPhone" class="form-input" placeholder="(11) 99999-9999" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Plano</label>
                        <select id="newUserPlan" class="form-input">
                            <option value="monthly">Mensal (30 dias)</option>
                            <option value="custom">Personalizado</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="customDaysGroup" style="display: none;">
                        <label class="form-label">Dias de Plano Personalizado *</label>
                        <input type="number" id="customPlanDays" class="form-input" min="1" max="365" value="30" placeholder="Digite o n√∫mero de dias">
                        <span class="form-hint">Digite a quantidade de dias que o plano ter√° (1-365)</span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select id="newUserStatus" class="form-input">
                            <option value="active">Ativo</option>
                            <option value="pending">Pendente</option>
                            <option value="blocked">Bloqueado</option>
                        </select>
                    </div>
                    
                    <div class="flex gap-2 mt-2">
                        <button type="button" class="submit-btn" style="background: #757575;" id="cancelNewUserBtn">
                            Cancelar
                        </button>
                        <button type="submit" class="submit-btn">
                            <i class="fas fa-user-plus"></i> Criar Usu√°rio
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div class="modal" id="deleteConfirmationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Confirmar Exclus√£o</h2>
                <button class="modal-close" id="closeDeleteModal">&times;</button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir este pagamento?</p>
                <div class="confirmation-text">
                    <strong>Digite "CONFIRMAR" para excluir:</strong>
                    <input type="text" id="confirmationInput" class="form-input mt-1" placeholder="Digite CONFIRMAR">
                </div>
                <div class="flex gap-2 mt-2">
                    <button type="button" class="submit-btn" style="background: #757575;" id="cancelDeleteBtn">
                        Cancelar
                    </button>
                    <button type="button" class="submit-btn" style="background: var(--danger-color);" id="confirmDeleteBtn" disabled>
                        <i class="fas fa-trash"></i> Excluir
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Carregando...</div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB7U-JfKAlkPxSyL4AEf5u0BgcDzSXf41M",
            authDomain: "appvendas-1eebf.firebaseapp.com",
            projectId: "appvendas-1eebf",
            storageBucket: "appvendas-1eebf.firebasestorage.app",
            messagingSenderId: "229472373918",
            appId: "1:229472373918:web:39cd4940b052b2375f3f8f"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Application state
        let adminUser = null;
        let users = [];
        let payments = [];
        let systemConfig = {};
        let currentPaymentToDelete = null;

        // DOM Elements
        const refreshBtn = document.getElementById('refreshBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const newUserBtn = document.getElementById('newUserBtn');
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        const statsGrid = document.getElementById('statsGrid');
        const usersList = document.getElementById('usersList');
        const usersEmpty = document.getElementById('usersEmpty');
        const paymentsList = document.getElementById('paymentsList');
        const paymentsEmpty = document.getElementById('paymentsEmpty');
        const searchUsers = document.getElementById('searchUsers');
        const searchPayments = document.getElementById('searchPayments');
        const adminInfo = document.getElementById('adminInfo');
        const clearCacheBtn = document.getElementById('clearCacheBtn');
        
        // Settings elements
        const paymentSettingsForm = document.getElementById('paymentSettingsForm');
        const pixKeyInput = document.getElementById('pixKey');
        const adminWhatsAppInput = document.getElementById('adminWhatsApp');
        const monthlyPlanPriceInput = document.getElementById('monthlyPlanPrice');
        const expirationWarningDaysInput = document.getElementById('expirationWarningDays');
        const whatsappMessageInput = document.getElementById('whatsappMessage');
        const paymentApprovedMessageInput = document.getElementById('paymentApprovedMessage');
        const paymentRejectedMessageInput = document.getElementById('paymentRejectedMessage');
        
        // New user form elements
        const newUserForm = document.getElementById('newUserForm');
        const newUserPlanSelect = document.getElementById('newUserPlan');
        const customDaysGroup = document.getElementById('customDaysGroup');
        const customPlanDaysInput = document.getElementById('customPlanDays');
        
        // Modals
        const userDetailsModal = document.getElementById('userDetailsModal');
        const closeUserModal = document.getElementById('closeUserModal');
        const paymentDetailsModal = document.getElementById('paymentDetailsModal');
        const closePaymentModal = document.getElementById('closePaymentModal');
        const newUserModal = document.getElementById('newUserModal');
        const closeNewUserModal = document.getElementById('closeNewUserModal');
        const cancelNewUserBtn = document.getElementById('cancelNewUserBtn');
        const deleteConfirmationModal = document.getElementById('deleteConfirmationModal');
        const closeDeleteModal = document.getElementById('closeDeleteModal');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const confirmationInput = document.getElementById('confirmationInput');
        
        // Loading overlay
        const loadingOverlay = document.getElementById('loadingOverlay');

        // Initialize the app
        async function init() {
            await checkAdminAuth();
            await loadSystemConfig();
            await loadAllUsers();
            await loadAllPayments();
            setupEventListeners();
            updateStats();
            updateAdminInfo();
        }

        // Check admin authentication
        async function checkAdminAuth() {
            try {
                // Check for admin session in localStorage
                const adminSession = localStorage.getItem('adminSession');
                if (!adminSession) {
                    redirectToLogin();
                    return;
                }
                
                const sessionData = JSON.parse(adminSession);
                adminUser = sessionData;
                
                // Verify session age
                const sessionAge = new Date() - new Date(sessionData.timestamp);
                const maxAge = 8 * 60 * 60 * 1000; // 8 hours
                
                if (sessionAge > maxAge) {
                    // Session expired
                    localStorage.removeItem('adminSession');
                    showNotification('Sess√£o expirada. Fa√ßa login novamente.', 'error');
                    setTimeout(() => {
                        redirectToLogin();
                    }, 2000);
                    return;
                }
                
                // Try to validate with Firebase Auth (optional)
                try {
                    const user = auth.currentUser;
                    if (user && user.email !== adminUser.email) {
                        // Different user, update session
                        adminUser = {
                            uid: user.uid,
                            email: user.email,
                            name: user.displayName,
                            photoURL: user.photoURL,
                            loggedIn: true,
                            timestamp: new Date().toISOString()
                        };
                        localStorage.setItem('adminSession', JSON.stringify(adminUser));
                    }
                } catch (authError) {
                    console.log('Auth check skipped:', authError);
                }
                
            } catch (error) {
                console.error('Admin auth error:', error);
                localStorage.removeItem('adminSession');
                redirectToLogin();
            }
        }

        // Function to redirect to login page
        function redirectToLogin() {
            // Show notification
            showNotification('Acesso n√£o autorizado. Redirecionando para login...', 'error');
            
            // Redirect to login page after a short delay
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 1500);
        }

        // Update admin info display
        function updateAdminInfo() {
            if (!adminUser) return;
            
            adminInfo.innerHTML = `
                <div class="flex items-center gap-2">
                    ${adminUser.photoURL ? 
                        `<img src="${adminUser.photoURL}" alt="${adminUser.name}" style="width: 24px; height: 24px; border-radius: 50%;">` : 
                        `<i class="fas fa-user" style="color: #757575;"></i>`
                    }
                    <div>
                        <div style="font-weight: 600;">${adminUser.name || 'Administrador'}</div>
                        <div style="font-size: 0.8rem; color: #757575;">${adminUser.email}</div>
                    </div>
                </div>
            `;
        }

        // Load system configuration
        async function loadSystemConfig() {
            try {
                const configDoc = await db.collection('systemConfig').doc('paymentSettings').get();
                if (configDoc.exists) {
                    systemConfig = configDoc.data();
                    updateSettingsForm();
                } else {
                    // Create default config
                    systemConfig = {
                        pixKey: 'chave-pix@empresa.com',
                        adminWhatsApp: '(11) 99999-9999',
                        monthlyPlanPrice: 99.00,
                        expirationWarningDays: 7,
                        whatsappMessage: `üì± *NOVO PAGAMENTO PENDENTE* üì±\n\nüë§ *Cliente:* {nome}\nüè™ *Loja:* {loja}\nüìß *E-mail:* {email}\nüì± *Telefone:* {telefone}\nüíµ *Plano:* Mensal\nüí∞ *Valor:* R$ {valor}\nüìÖ *Data:* {data}\n\n‚ö†Ô∏è *Status:* Aguardando confirma√ß√£o\n\nPor favor, acesse o painel administrativo para verificar o comprovante e liberar o acesso.`,
                        paymentApprovedMessage: `‚úÖ *PAGAMENTO APROVADO!* ‚úÖ\n\nOl√° {nome}! üëã\n\nSeu pagamento foi *APROVADO* com sucesso! üéâ\n\nüè™ *Loja:* {loja}\nüíµ *Plano:* {plano}\nüìÖ *V√°lido at√©:* {validade}\nüí∞ *Valor:* R$ {valor}\n\nAgora voc√™ j√° pode acessar sua conta e come√ßar a usar todas as funcionalidades do Venda+!\n\nüîó *Acesse:* https://seusite.com/login\n\nEm caso de d√∫vidas, estamos √† disposi√ß√£o!\n\nAtenciosamente,\nEquipe Venda+ üì±`,
                        paymentRejectedMessage: `‚ùå *PAGAMENTO REJEITADO* ‚ùå\n\nOl√° {nome},\n\nLamentamos informar que seu pagamento foi *REJEITADO*.\n\nüè™ *Loja:* {loja}\nüíµ *Plano:* {plano}\nüí∞ *Valor:* R$ {valor}\nüìÖ *Data:* {data}\n\nüìã *Motivo:* Comprovante n√£o identificado ou informa√ß√µes inconsistentes.\n\nüîç *O que fazer:*\n1. Verifique se o comprovante est√° leg√≠vel\n2. Confirme se os dados est√£o corretos\n3. Envie novamente o comprovante\n\nPara mais informa√ß√µes, entre em contato conosco.\n\nAtenciosamente,\nEquipe Venda+ üì±`,
                        updatedAt: new Date().toISOString()
                    };
                    await db.collection('systemConfig').doc('paymentSettings').set(systemConfig);
                    updateSettingsForm();
                }
            } catch (error) {
                console.error('Error loading system config:', error);
                showNotification('Configura√ß√µes carregadas com padr√µes.', 'info');
            }
        }

        // Update settings form
        function updateSettingsForm() {
            if (pixKeyInput) pixKeyInput.value = systemConfig.pixKey || '';
            if (adminWhatsAppInput) adminWhatsAppInput.value = systemConfig.adminWhatsApp || '';
            if (monthlyPlanPriceInput) monthlyPlanPriceInput.value = systemConfig.monthlyPlanPrice || 99.00;
            if (expirationWarningDaysInput) expirationWarningDaysInput.value = systemConfig.expirationWarningDays || 7;
            if (whatsappMessageInput) whatsappMessageInput.value = systemConfig.whatsappMessage || '';
            if (paymentApprovedMessageInput) paymentApprovedMessageInput.value = systemConfig.paymentApprovedMessage || '';
            if (paymentRejectedMessageInput) paymentRejectedMessageInput.value = systemConfig.paymentRejectedMessage || '';
        }

        // Load all users
        async function loadAllUsers() {
            try {
                showLoading();
                const snapshot = await db.collection('users').get();
                
                users = [];
                snapshot.forEach(doc => {
                    const userData = doc.data();
                    users.push({
                        id: doc.id,
                        ...userData
                    });
                });
                
                // Sort by creation date (newest first)
                users.sort((a, b) => {
                    return new Date(b.createdAt || b.timestamp) - new Date(a.createdAt || a.timestamp);
                });
                
                updateUsersList();
                updateStats();
                hideLoading();
            } catch (error) {
                console.error('Error loading users:', error);
                showNotification('Erro ao carregar usu√°rios.', 'error');
                hideLoading();
            }
        }

        // Load all payments
        async function loadAllPayments() {
            try {
                const snapshot = await db.collection('payments').orderBy('createdAt', 'desc').get();
                
                payments = [];
                snapshot.forEach(doc => {
                    const paymentData = doc.data();
                    payments.push({
                        id: doc.id,
                        ...paymentData
                    });
                });
                
                updatePaymentsList();
            } catch (error) {
                console.error('Error loading payments:', error);
                showNotification('Erro ao carregar pagamentos.', 'error');
            }
        }

        // Update stats
        function updateStats() {
            const totalUsers = users.length;
            const activeUsers = users.filter(user => user.status === 'active').length;
            const pendingUsers = users.filter(user => user.status === 'pending').length;
            const blockedUsers = users.filter(user => user.status === 'blocked').length;
            const expiredUsers = users.filter(user => user.status === 'expired').length;
            const monthlyRevenue = activeUsers * (systemConfig.monthlyPlanPrice || 99);
            
            const stats = [
                { icon: 'users', label: 'Total', value: totalUsers, color: 'total' },
                { icon: 'check-circle', label: 'Ativos', value: activeUsers, color: 'active' },
                { icon: 'clock', label: 'Pendentes', value: pendingUsers, color: 'pending' },
                { icon: 'ban', label: 'Bloqueados', value: blockedUsers, color: 'blocked' },
                { icon: 'calendar-times', label: 'Expirados', value: expiredUsers, color: 'expired' },
                { icon: 'money-bill-wave', label: 'Receita', value: `R$ ${monthlyRevenue}`, color: 'revenue' }
            ];
            
            statsGrid.innerHTML = '';
            stats.forEach(stat => {
                const statCard = document.createElement('div');
                statCard.className = 'stat-card';
                statCard.innerHTML = `
                    <div class="stat-row">
                        <div class="stat-icon ${stat.color}">
                            <i class="fas fa-${stat.icon}"></i>
                        </div>
                        <div class="stat-number">${stat.value}</div>
                    </div>
                    <div class="stat-label">${stat.label}</div>
                `;
                statsGrid.appendChild(statCard);
            });
        }

        // Update users list - COM CLIQUE NO CARD INTEIRO
        function updateUsersList() {
            usersList.innerHTML = '';
            
            if (users.length === 0) {
                usersEmpty.style.display = 'block';
                return;
            }
            
            usersEmpty.style.display = 'none';
            
            const searchTerm = searchUsers.value.toLowerCase();
            
            users.forEach(user => {
                if (searchTerm && 
                    !user.storeName?.toLowerCase().includes(searchTerm) &&
                    !user.email?.toLowerCase().includes(searchTerm)) {
                    return;
                }
                
                const status = user.status || 'pending';
                const expiryDate = user.expiryDate || 'N√£o definida';
                const phone = user.phone || 'N√£o informado';
                
                const statusText = getStatusText(status);
                const statusClass = getStatusClass(status);
                
                const userItem = document.createElement('div');
                userItem.className = 'list-item';
                userItem.setAttribute('data-user-id', user.id);
                userItem.style.cursor = 'pointer';
                userItem.innerHTML = `
                    <div class="item-header">
                        <div>
                            <div class="item-title">${user.storeName || 'Sem nome'}</div>
                            <div class="item-subtitle">${user.email}</div>
                            <div class="item-subtitle">${phone}</div>
                        </div>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </div>
                    
                    <div class="item-details">
                        <div class="detail-item">
                            <span class="detail-label">Status</span>
                            <span class="detail-value">${statusText}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Expira em</span>
                            <span class="detail-value">${expiryDate}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Plano</span>
                            <span class="detail-value">${user.plan === 'monthly' ? 'Mensal' : user.plan === 'custom' ? 'Personalizado' : user.plan}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Cadastro</span>
                            <span class="detail-value">${formatDate(user.createdAt)}</span>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="action-btn btn-view" data-id="${user.id}" data-action="view">
                            <i class="fas fa-eye"></i> Ver
                        </button>
                        ${status === 'active' ? `
                            <button class="action-btn btn-block" data-id="${user.id}" data-action="block">
                                <i class="fas fa-ban"></i> Bloquear
                            </button>
                        ` : `
                            <button class="action-btn btn-activate" data-id="${user.id}" data-action="activate">
                                <i class="fas fa-check"></i> Ativar
                            </button>
                        `}
                    </div>
                `;
                
                usersList.appendChild(userItem);
                
                // Add click event to the entire card
                userItem.addEventListener('click', (e) => {
                    // Prevent triggering when clicking on buttons
                    if (e.target.closest('.action-btn')) {
                        return;
                    }
                    const userId = e.currentTarget.getAttribute('data-user-id');
                    viewUserDetails(userId);
                });
            });
            
            // Add event listeners to buttons
            usersList.querySelectorAll('[data-action="view"]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent card click
                    const userId = e.currentTarget.getAttribute('data-id');
                    viewUserDetails(userId);
                });
            });
            
            usersList.querySelectorAll('[data-action="block"]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent card click
                    const userId = e.currentTarget.getAttribute('data-id');
                    toggleUserStatus(userId, 'blocked');
                });
            });
            
            usersList.querySelectorAll('[data-action="activate"]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent card click
                    const userId = e.currentTarget.getAttribute('data-id');
                    toggleUserStatus(userId, 'active');
                });
            });
        }

        // Update payments list - COM BOT√ÉO WHATSAPP
        function updatePaymentsList() {
            paymentsList.innerHTML = '';
            
            if (payments.length === 0) {
                paymentsEmpty.style.display = 'block';
                return;
            }
            
            paymentsEmpty.style.display = 'none';
            
            const searchTerm = searchPayments.value.toLowerCase();
            
            payments.forEach(payment => {
                if (searchTerm && 
                    !payment.userName?.toLowerCase().includes(searchTerm) &&
                    !payment.storeName?.toLowerCase().includes(searchTerm) &&
                    !payment.userEmail?.toLowerCase().includes(searchTerm)) {
                    return;
                }
                
                const status = payment.status || 'pending';
                const statusText = getPaymentStatusText(status);
                const statusClass = getPaymentStatusClass(status);
                
                const paymentItem = document.createElement('div');
                paymentItem.className = 'list-item';
                paymentItem.setAttribute('data-payment-id', payment.id);
                paymentItem.style.cursor = 'pointer';
                paymentItem.innerHTML = `
                    <div class="item-header">
                        <div>
                            <div class="item-title">${payment.userName || 'Nome n√£o informado'}</div>
                            <div class="item-subtitle">${payment.storeName || 'Sem nome'}</div>
                            <div class="item-subtitle">${payment.userEmail}</div>
                        </div>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </div>
                    
                    <div class="item-details">
                        <div class="detail-item">
                            <span class="detail-label">Plano</span>
                            <span class="detail-value">${payment.plan === 'monthly' ? 'Mensal' : 'Personalizado'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Valor</span>
                            <span class="detail-value">R$ ${payment.amount?.toFixed(2).replace('.', ',') || '0,00'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Data</span>
                            <span class="detail-value">${formatDate(payment.createdAt)}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Telefone</span>
                            <span class="detail-value">${payment.userPhone || 'N√£o informado'}</span>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="action-btn btn-view" data-id="${payment.id}" data-action="view">
                            <i class="fas fa-eye"></i> Ver
                        </button>
                        ${status === 'pending' ? `
                            <button class="action-btn btn-approve" data-id="${payment.id}" data-action="approve">
                                <i class="fas fa-check"></i> Aprovar
                            </button>
                            <button class="action-btn btn-reject" data-id="${payment.id}" data-action="reject">
                                <i class="fas fa-times"></i> Rejeitar
                            </button>
                        ` : `
                            <button class="action-btn btn-whatsapp" data-id="${payment.id}" data-action="whatsapp">
                                <i class="fas fa-whatsapp"></i> WhatsApp
                            </button>
                            <button class="action-btn btn-delete" data-id="${payment.id}" data-action="delete">
                                <i class="fas fa-trash"></i> Excluir
                            </button>
                        `}
                    </div>
                `;
                
                paymentsList.appendChild(paymentItem);
                
                // Add click event to the entire card
                paymentItem.addEventListener('click', (e) => {
                    // Prevent triggering when clicking on buttons
                    if (e.target.closest('.action-btn')) {
                        return;
                    }
                    const paymentId = e.currentTarget.getAttribute('data-payment-id');
                    viewPaymentDetails(paymentId);
                });
            });
            
            // Add event listeners to buttons
            paymentsList.querySelectorAll('[data-action="view"]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent card click
                    const paymentId = e.currentTarget.getAttribute('data-id');
                    viewPaymentDetails(paymentId);
                });
            });
            
            paymentsList.querySelectorAll('[data-action="approve"]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent card click
                    const paymentId = e.currentTarget.getAttribute('data-id');
                    approvePayment(paymentId);
                });
            });
            
            paymentsList.querySelectorAll('[data-action="reject"]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent card click
                    const paymentId = e.currentTarget.getAttribute('data-id');
                    rejectPayment(paymentId);
                });
            });
            
            paymentsList.querySelectorAll('[data-action="delete"]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent card click
                    const paymentId = e.currentTarget.getAttribute('data-id');
                    showDeleteConfirmation(paymentId);
                });
            });
            
            paymentsList.querySelectorAll('[data-action="whatsapp"]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent card click
                    const paymentId = e.currentTarget.getAttribute('data-id');
                    sendWhatsAppMessage(paymentId);
                });
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            refreshBtn.addEventListener('click', async () => {
                await loadAllUsers();
                await loadAllPayments();
                showNotification('Dados atualizados!', 'success');
            });
            
            logoutBtn.addEventListener('click', logout);
            
            newUserBtn.addEventListener('click', () => {
                newUserModal.style.display = 'flex';
                setTimeout(() => {
                    document.getElementById('newStoreName')?.focus();
                }, 300);
            });
            
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabId = btn.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            searchUsers.addEventListener('input', () => {
                updateUsersList();
            });
            
            searchPayments.addEventListener('input', () => {
                updatePaymentsList();
            });
            
            paymentSettingsForm.addEventListener('submit', saveSystemConfig);
            
            clearCacheBtn.addEventListener('click', clearCache);
            
            closeUserModal.addEventListener('click', () => {
                userDetailsModal.style.display = 'none';
            });
            
            closePaymentModal.addEventListener('click', () => {
                paymentDetailsModal.style.display = 'none';
            });
            
            closeNewUserModal.addEventListener('click', () => {
                newUserModal.style.display = 'none';
                newUserForm.reset();
                customDaysGroup.style.display = 'none';
            });
            
            cancelNewUserBtn.addEventListener('click', () => {
                newUserModal.style.display = 'none';
                newUserForm.reset();
                customDaysGroup.style.display = 'none';
            });
            
            closeDeleteModal.addEventListener('click', () => {
                deleteConfirmationModal.style.display = 'none';
                resetDeleteConfirmation();
            });
            
            cancelDeleteBtn.addEventListener('click', () => {
                deleteConfirmationModal.style.display = 'none';
                resetDeleteConfirmation();
            });
            
            newUserForm.addEventListener('submit', createNewUser);
            
            newUserPlanSelect.addEventListener('change', function() {
                if (this.value === 'custom') {
                    customDaysGroup.style.display = 'block';
                } else {
                    customDaysGroup.style.display = 'none';
                }
            });
            
            window.addEventListener('click', (e) => {
                if (e.target === userDetailsModal) userDetailsModal.style.display = 'none';
                if (e.target === paymentDetailsModal) paymentDetailsModal.style.display = 'none';
                if (e.target === newUserModal) {
                    newUserModal.style.display = 'none';
                    newUserForm.reset();
                    customDaysGroup.style.display = 'none';
                }
                if (e.target === deleteConfirmationModal) {
                    deleteConfirmationModal.style.display = 'none';
                    resetDeleteConfirmation();
                }
            });
            
            confirmationInput.addEventListener('input', function() {
                confirmDeleteBtn.disabled = this.value !== 'CONFIRMAR';
            });
            
            confirmDeleteBtn.addEventListener('click', deletePayment);
            
            if (adminWhatsAppInput) {
                new IMask(adminWhatsAppInput, {
                    mask: '(00) 00000-0000',
                    lazy: false
                });
            }
        }

        // Reset delete confirmation modal
        function resetDeleteConfirmation() {
            confirmationInput.value = '';
            confirmDeleteBtn.disabled = true;
            currentPaymentToDelete = null;
        }

        // Switch tab
        function switchTab(tabId) {
            tabBtns.forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-tab') === tabId) {
                    btn.classList.add('active');
                }
            });
            
            tabContents.forEach(content => {
                content.classList.remove('active');
                if (content.id === `${tabId}Tab`) {
                    content.classList.add('active');
                }
            });
        }

        // View user details
        async function viewUserDetails(userId) {
            const user = users.find(user => user.id === userId);
            if (!user) return;
            
            const status = user.status || 'pending';
            const expiryDate = user.expiryDate || 'N√£o definida';
            const createdAt = user.createdAt ? formatDateTime(user.createdAt) : 'N√£o informada';
            const lastLogin = user.lastLogin ? formatDateTime(user.lastLogin) : 'Nunca logou';
            const phone = user.phone || 'N√£o informado';
            
            const statusText = getStatusText(status);
            const statusClass = getStatusClass(status);
            
            const content = `
                <div class="settings-section" style="border: none; padding: 0; box-shadow: none;">
                    <div class="form-group">
                        <label class="form-label">Nome da Loja</label>
                        <div class="form-input" style="background: #f8f9fa;">${user.storeName || 'Sem nome'}</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">E-mail</label>
                        <div class="form-input" style="background: #f8f9fa;">${user.email}</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Telefone</label>
                        <div class="form-input" style="background: #f8f9fa;">${phone}</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <div class="form-input" style="background: #f8f9fa;">
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Data de Cadastro</label>
                        <div class="form-input" style="background: #f8f9fa;">${createdAt}</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">√öltimo Login</label>
                        <div class="form-input" style="background: #f8f9fa;">${lastLogin}</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Expira em</label>
                        <div class="form-input" style="background: #f8f9fa;">${expiryDate}</div>
                    </div>
                    
                    <div class="flex gap-2 mt-2">
                        <button type="button" class="submit-btn" style="background: #757575;" id="closeDetailsBtn">
                            Fechar
                        </button>
                        ${status === 'active' ? `
                            <button type="button" class="submit-btn" style="background: var(--danger-color);" id="blockUserBtn">
                                <i class="fas fa-ban"></i> Bloquear
                            </button>
                        ` : `
                            <button type="button" class="submit-btn" style="background: var(--success-color);" id="activateUserBtn">
                                <i class="fas fa-check"></i> Ativar
                            </button>
                        `}
                    </div>
                </div>
            `;
            
            document.getElementById('userDetailsContent').innerHTML = content;
            
            document.getElementById('closeDetailsBtn')?.addEventListener('click', () => {
                userDetailsModal.style.display = 'none';
            });
            
            document.getElementById('blockUserBtn')?.addEventListener('click', () => {
                userDetailsModal.style.display = 'none';
                toggleUserStatus(userId, 'blocked');
            });
            
            document.getElementById('activateUserBtn')?.addEventListener('click', () => {
                userDetailsModal.style.display = 'none';
                toggleUserStatus(userId, 'active');
            });
            
            userDetailsModal.style.display = 'flex';
        }

        // Toggle user status
        async function toggleUserStatus(userId, newStatus) {
            try {
                const user = users.find(u => u.id === userId);
                if (!user) return;
                
                const statusText = getStatusText(newStatus);
                
                let updateData = { 
                    status: newStatus,
                    updatedAt: new Date().toISOString()
                };
                
                if (newStatus === 'active') {
                    const expiryDate = new Date();
                    expiryDate.setDate(expiryDate.getDate() + 30);
                    updateData.expiryDate = expiryDate.toISOString().split('T')[0];
                    updateData.isActive = true;
                    
                } else if (newStatus === 'blocked') {
                    updateData.isActive = false;
                }
                
                await db.collection('users').doc(userId).update(updateData);
                
                const userIndex = users.findIndex(u => u.id === userId);
                if (userIndex !== -1) {
                    users[userIndex] = { ...users[userIndex], ...updateData };
                }
                
                updateUsersList();
                updateStats();
                showNotification(`Usu√°rio ${statusText.toLowerCase()}!`, 'success');
                
            } catch (error) {
                console.error('Error updating user status:', error);
                showNotification('Erro ao atualizar status.', 'error');
            }
        }

        // View payment details - COM BOT√ÉO WHATSAPP
        function viewPaymentDetails(paymentId) {
            const payment = payments.find(p => p.id === paymentId);
            if (!payment) return;
            
            const statusText = getPaymentStatusText(payment.status);
            const statusClass = getPaymentStatusClass(payment.status);
            
            const content = `
                <div class="settings-section" style="border: none; padding: 0; box-shadow: none;">
                    <div class="form-group">
                        <label class="form-label">Cliente</label>
                        <div class="form-input" style="background: #f8f9fa;">${payment.userName || 'Nome n√£o informado'}</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Loja</label>
                        <div class="form-input" style="background: #f8f9fa;">${payment.storeName || 'Sem nome'}</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">E-mail</label>
                        <div class="form-input" style="background: #f8f9fa;">${payment.userEmail}</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Telefone</label>
                        <div class="form-input" style="background: #f8f9fa;">${payment.userPhone || 'N√£o informado'}</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <div class="form-input" style="background: #f8f9fa;">
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Plano</label>
                        <div class="form-input" style="background: #f8f9fa;">${payment.plan === 'monthly' ? 'Mensal' : 'Personalizado'}</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Valor</label>
                        <div class="form-input" style="background: #f8f9fa;">R$ ${payment.amount?.toFixed(2).replace('.', ',') || '0,00'}</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Data</label>
                        <div class="form-input" style="background: #f8f9fa;">${formatDateTime(payment.createdAt)}</div>
                    </div>
                    
                    ${payment.approvedAt ? `
                        <div class="form-group">
                            <label class="form-label">Aprovado em</label>
                            <div class="form-input" style="background: #f8f9fa;">${formatDateTime(payment.approvedAt)}</div>
                        </div>
                    ` : ''}
                    
                    ${payment.rejectedAt ? `
                        <div class="form-group">
                            <label class="form-label">Rejeitado em</label>
                            <div class="form-input" style="background: #f8f9fa;">${formatDateTime(payment.rejectedAt)}</div>
                        </div>
                    ` : ''}
                    
                    ${payment.receiptBase64 ? `
                        <div class="form-group">
                            <label class="form-label">Comprovante</label>
                            <div style="text-align: center; margin-top: 8px;">
                                ${payment.receiptType === 'pdf' ? 
                                    `<button class="action-btn btn-view" onclick="downloadReceipt('${payment.id}')" style="width: 100%;">
                                        <i class="fas fa-file-pdf"></i> Baixar Comprovante PDF
                                    </button>` :
                                    `<img src="${payment.receiptBase64}" alt="Comprovante" style="max-width: 100%; max-height: 200px; border-radius: 8px; cursor: pointer;" onclick="openImageZoom('${payment.receiptBase64}')">`
                                }
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="flex gap-2 mt-2">
                        <button type="button" class="submit-btn" style="background: #757575;" id="closePaymentBtn">
                            Fechar
                        </button>
                        ${payment.status === 'pending' ? `
                            <button type="button" class="submit-btn" style="background: var(--success-color);" id="approvePaymentBtn">
                                <i class="fas fa-check"></i> Aprovar
                            </button>
                            <button type="button" class="submit-btn" style="background: var(--danger-color);" id="rejectPaymentBtn">
                                <i class="fas fa-times"></i> Rejeitar
                            </button>
                        ` : `
                            <button type="button" class="submit-btn" style="background: #25D366;" id="sendWhatsAppBtn">
                                <i class="fas fa-whatsapp"></i> Enviar WhatsApp
                            </button>
                            <button type="button" class="submit-btn" style="background: var(--danger-color);" id="deletePaymentBtn">
                                <i class="fas fa-trash"></i> Excluir
                            </button>
                        `}
                    </div>
                </div>
            `;
            
            document.getElementById('paymentDetailsContent').innerHTML = content;
            
            document.getElementById('closePaymentBtn')?.addEventListener('click', () => {
                paymentDetailsModal.style.display = 'none';
            });
            
            document.getElementById('approvePaymentBtn')?.addEventListener('click', async () => {
                paymentDetailsModal.style.display = 'none';
                await approvePayment(paymentId);
            });
            
            document.getElementById('rejectPaymentBtn')?.addEventListener('click', async () => {
                paymentDetailsModal.style.display = 'none';
                await rejectPayment(paymentId);
            });
            
            document.getElementById('sendWhatsAppBtn')?.addEventListener('click', async () => {
                paymentDetailsModal.style.display = 'none';
                await sendWhatsAppMessage(paymentId);
            });
            
            document.getElementById('deletePaymentBtn')?.addEventListener('click', async () => {
                paymentDetailsModal.style.display = 'none';
                showDeleteConfirmation(paymentId);
            });
            
            window.downloadReceipt = function(id) {
                const p = payments.find(p => p.id === id);
                if (p && p.receiptBase64) {
                    const link = document.createElement('a');
                    link.href = p.receiptBase64;
                    link.download = p.receiptFileName || 'comprovante.pdf';
                    link.click();
                }
            };
            
            window.openImageZoom = function(imageSrc) {
                window.open(imageSrc, '_blank');
            };
            
            paymentDetailsModal.style.display = 'flex';
        }

        // Approve payment
        async function approvePayment(paymentId) {
            try {
                const payment = payments.find(p => p.id === paymentId);
                if (!payment) return;
                
                const userId = payment.userId;
                
                // Update payment status
                await db.collection('payments').doc(paymentId).update({
                    status: 'approved',
                    approvedAt: new Date().toISOString(),
                    approvedBy: adminUser.email
                });
                
                // Calculate expiry date based on plan
                const expiryDate = new Date();
                let planDays = 30;
                
                if (payment.plan === 'custom' && payment.planDays) {
                    planDays = parseInt(payment.planDays) || 30;
                }
                
                expiryDate.setDate(expiryDate.getDate() + planDays);
                const expiryDateStr = expiryDate.toISOString().split('T')[0];
                
                // Update user status and set expiry date
                await db.collection('users').doc(userId).update({
                    status: 'active',
                    isActive: true,
                    expiryDate: expiryDateStr,
                    plan: payment.plan || 'monthly',
                    planDays: payment.planDays || 30,
                    paymentConfirmed: true,
                    lastPaymentDate: new Date().toISOString()
                });
                
                showNotification('Pagamento aprovado! Usu√°rio ativado.', 'success');
                
                // Reload data
                await loadAllUsers();
                await loadAllPayments();
                
            } catch (error) {
                console.error('Error approving payment:', error);
                showNotification('Erro ao aprovar pagamento.', 'error');
            }
        }

        // Reject payment
        async function rejectPayment(paymentId) {
            try {
                await db.collection('payments').doc(paymentId).update({
                    status: 'rejected',
                    rejectedAt: new Date().toISOString(),
                    rejectedBy: adminUser.email
                });
                
                showNotification('Pagamento rejeitado!', 'warning');
                
                await loadAllPayments();
                
            } catch (error) {
                console.error('Error rejecting payment:', error);
                showNotification('Erro ao rejeitar pagamento.', 'error');
            }
        }

        // Send WhatsApp message for approved/rejected payments
        async function sendWhatsAppMessage(paymentId) {
            try {
                const payment = payments.find(p => p.id === paymentId);
                if (!payment) return;
                
                const userPhone = payment.userPhone;
                if (!userPhone) {
                    showNotification('Telefone do cliente n√£o informado.', 'error');
                    return;
                }
                
                // Clean phone number
                const cleanPhone = userPhone.replace(/\D/g, '');
                if (cleanPhone.length < 10) {
                    showNotification('N√∫mero de telefone inv√°lido.', 'error');
                    return;
                }
                
                // Get appropriate message based on status
                let messageTemplate = '';
                let messageType = '';
                
                if (payment.status === 'approved') {
                    messageTemplate = systemConfig.paymentApprovedMessage || '';
                    messageType = 'aprovado';
                } else if (payment.status === 'rejected') {
                    messageTemplate = systemConfig.paymentRejectedMessage || '';
                    messageType = 'rejeitado';
                } else {
                    showNotification('S√≥ √© poss√≠vel enviar WhatsApp para pagamentos aprovados ou rejeitados.', 'warning');
                    return;
                }
                
                if (!messageTemplate) {
                    showNotification(`Mensagem de ${messageType} n√£o configurada.`, 'error');
                    return;
                }
                
                // Get user info for message variables
                const user = users.find(u => u.id === payment.userId);
                
                // Format date for message
                const paymentDate = new Date(payment.createdAt);
                const formattedDate = paymentDate.toLocaleDateString('pt-BR');
                
                // Get expiry date for approved payments
                let expiryDate = '';
                if (payment.status === 'approved' && user) {
                    expiryDate = user.expiryDate || '';
                    if (expiryDate) {
                        const expiryDateObj = new Date(expiryDate);
                        expiryDate = expiryDateObj.toLocaleDateString('pt-BR');
                    }
                }
                
                // Replace variables in message
                let finalMessage = messageTemplate
                    .replace(/{nome}/g, payment.userName || 'Cliente')
                    .replace(/{loja}/g, payment.storeName || '')
                    .replace(/{plano}/g, payment.plan === 'monthly' ? 'Mensal' : 'Personalizado')
                    .replace(/{valor}/g, payment.amount?.toFixed(2).replace('.', ',') || '0,00')
                    .replace(/{data}/g, formattedDate)
                    .replace(/{validade}/g, expiryDate)
                    .replace(/{email}/g, payment.userEmail || '')
                    .replace(/{telefone}/g, payment.userPhone || '');
                
                // Encode message for URL
                const encodedMessage = encodeURIComponent(finalMessage);
                
                // Create WhatsApp URL with direct link (no popup issues)
                const whatsappUrl = `https://wa.me/55${cleanPhone}?text=${encodedMessage}`;
                
                // Create and trigger a direct link click
                const link = document.createElement('a');
                link.href = whatsappUrl;
                link.target = '_blank'; // Open in new tab instead of popup
                link.rel = 'noopener noreferrer';
                link.style.display = 'none';
                document.body.appendChild(link);
                
                // Use a user gesture to trigger the click
                link.click();
                
                // Remove the link after click
                setTimeout(() => {
                    document.body.removeChild(link);
                }, 100);
                
                // Show success notification
                showNotification(`WhatsApp enviado! Status: ${messageType}`, 'success');
                
                // Log the WhatsApp sending
                await db.collection('payments').doc(paymentId).update({
                    whatsappSent: true,
                    whatsappSentAt: new Date().toISOString(),
                    whatsappSentBy: adminUser.email
                });
                
            } catch (error) {
                console.error('Error sending WhatsApp:', error);
                showNotification('Erro ao enviar WhatsApp.', 'error');
            }
        }

        // Show delete confirmation modal
        function showDeleteConfirmation(paymentId) {
            currentPaymentToDelete = paymentId;
            deleteConfirmationModal.style.display = 'flex';
            setTimeout(() => {
                confirmationInput.focus();
            }, 300);
        }

        // Delete payment
        async function deletePayment() {
            if (!currentPaymentToDelete) return;
            
            try {
                await db.collection('payments').doc(currentPaymentToDelete).delete();
                
                const paymentIndex = payments.findIndex(p => p.id === currentPaymentToDelete);
                if (paymentIndex !== -1) {
                    payments.splice(paymentIndex, 1);
                }
                
                deleteConfirmationModal.style.display = 'none';
                resetDeleteConfirmation();
                
                updatePaymentsList();
                showNotification('Pagamento exclu√≠do com sucesso!', 'success');
                
            } catch (error) {
                console.error('Error deleting payment:', error);
                showNotification('Erro ao excluir pagamento.', 'error');
            }
        }

        // Create new user manually
        async function createNewUser(e) {
            e.preventDefault();
            
            const storeName = document.getElementById('newStoreName').value;
            const email = document.getElementById('newUserEmail').value;
            const password = document.getElementById('newUserPassword').value;
            const phone = document.getElementById('newUserPhone').value;
            const status = document.getElementById('newUserStatus').value;
            const plan = document.getElementById('newUserPlan').value;
            const customDays = plan === 'custom' ? parseInt(document.getElementById('customPlanDays').value) || 30 : 30;
            
            if (!phone || phone.replace(/\D/g, '').length < 11) {
                showNotification('Informe um n√∫mero de WhatsApp v√°lido.', 'error');
                return;
            }
            
            if (plan === 'custom' && (customDays < 1 || customDays > 365)) {
                showNotification('Os dias do plano personalizado devem estar entre 1 e 365.', 'error');
                return;
            }
            
            try {
                showLoading();
                
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                let expiryDate = '';
                if (status === 'active') {
                    const date = new Date();
                    date.setDate(date.getDate() + customDays);
                    expiryDate = date.toISOString().split('T')[0];
                }
                
                await db.collection('users').doc(user.uid).set({
                    uid: user.uid,
                    email: user.email,
                    storeName: storeName,
                    phone: phone,
                    status: status,
                    plan: plan,
                    planDays: customDays,
                    expiryDate: expiryDate,
                    isActive: status === 'active',
                    configCompleted: false,
                    createdAt: new Date().toISOString(),
                    createdBy: adminUser.email,
                    lastActivity: new Date().toISOString()
                });
                
                newUserModal.style.display = 'none';
                newUserForm.reset();
                customDaysGroup.style.display = 'none';
                
                await loadAllUsers();
                
                showNotification('Usu√°rio criado com sucesso!', 'success');
                hideLoading();
                
            } catch (error) {
                console.error('Error creating user:', error);
                let errorMessage = 'Erro ao criar usu√°rio.';
                
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Este e-mail j√° est√° em uso.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'E-mail inv√°lido.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Senha muito fraca. Use pelo menos 6 caracteres.';
                }
                
                showNotification(errorMessage, 'error');
                hideLoading();
            }
        }

        // Save system configuration
        async function saveSystemConfig(e) {
            e.preventDefault();
            
            const configData = {
                pixKey: pixKeyInput.value,
                adminWhatsApp: adminWhatsAppInput.value,
                monthlyPlanPrice: parseFloat(monthlyPlanPriceInput.value) || 99.00,
                expirationWarningDays: parseInt(expirationWarningDaysInput.value) || 7,
                whatsappMessage: whatsappMessageInput.value,
                paymentApprovedMessage: paymentApprovedMessageInput.value,
                paymentRejectedMessage: paymentRejectedMessageInput.value,
                updatedAt: new Date().toISOString(),
                updatedBy: adminUser.email
            };
            
            try {
                await db.collection('systemConfig').doc('paymentSettings').set(configData, { merge: true });
                systemConfig = configData;
                showNotification('Configura√ß√µes salvas!', 'success');
            } catch (error) {
                console.error('Error saving system config:', error);
                showNotification('Erro ao salvar configura√ß√µes.', 'error');
            }
        }

        // Clear cache
        function clearCache() {
            localStorage.removeItem('adminSession');
            showNotification('Cache limpo! A p√°gina ser√° recarregada.', 'info');
            setTimeout(() => {
                location.reload();
            }, 1500);
        }

        // Logout
        async function logout() {
            try {
                try {
                    await auth.signOut();
                } catch (authError) {
                    console.log('Auth signout skipped:', authError);
                }
                
                localStorage.removeItem('adminSession');
                
                showNotification('Logout realizado!', 'success');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 1000);
                
            } catch (error) {
                console.error('Error logging out:', error);
                showNotification('Erro ao fazer logout.', 'error');
            }
        }

        // Show notification
        function showNotification(message, type = 'info', duration = 3000) {
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => {
                notification.remove();
            });
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, duration);
        }

        // Show loading overlay
        function showLoading() {
            loadingOverlay.style.display = 'flex';
        }

        // Hide loading overlay
        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }

        // Helper functions
        function formatDate(dateString) {
            if (!dateString) return 'Data n√£o informada';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('pt-BR');
            } catch (error) {
                return 'Data inv√°lida';
            }
        }
        
        function formatDateTime(dateString) {
            if (!dateString) return 'Data/hora n√£o informada';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            } catch (error) {
                return 'Data inv√°lida';
            }
        }
        
        function getStatusText(status) {
            switch(status) {
                case 'active': return 'Ativo';
                case 'pending': return 'Pendente';
                case 'blocked': return 'Bloqueado';
                case 'expired': return 'Expirado';
                default: return 'Desconhecido';
            }
        }
        
        function getStatusClass(status) {
            switch(status) {
                case 'active': return 'status-active';
                case 'pending': return 'status-pending';
                case 'blocked': return 'status-blocked';
                case 'expired': return 'status-expired';
                default: return 'status-pending';
            }
        }
        
        function getPaymentStatusText(status) {
            switch(status) {
                case 'pending': return 'Pendente';
                case 'approved': return 'Aprovado';
                case 'rejected': return 'Rejeitado';
                default: return 'Desconhecido';
            }
        }
        
        function getPaymentStatusClass(status) {
            switch(status) {
                case 'pending': return 'status-pending';
                case 'approved': return 'status-approved';
                case 'rejected': return 'status-rejected';
                default: return 'status-pending';
            }
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>