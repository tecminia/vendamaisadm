<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Venda+</title>
    <link rel="icon" href="favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/imask/6.4.3/imask.min.js"></script>
    
    <meta name="format-detection" content="telephone=no">
    <meta name="format-detection" content="date=no">
    <meta name="format-detection" content="address=no">
    <meta name="format-detection" content="email=no">
    
    <style>
        :root {
            --primary-color: #212121;
            --secondary-color: #424242;
            --success-color: #4CAF50;
            --warning-color: #FF9800;
            --danger-color: #F44336;
            --info-color: #2196F3;
            --light-bg: #f5f5f5;
            --card-bg: #ffffff;
            --border-color: #e0e0e0;
            --text-primary: #212121;
            --text-secondary: #757575;
            --shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
        }
        
        html, body {
            height: 100%;
            overflow: hidden;
            background: var(--light-bg);
            color: var(--text-primary);
        }
        
        body {
            font-size: 14px;
            padding: 0;
            display: flex;
            flex-direction: column;
        }
        
        .admin-header,
        .stats-grid,
        .stat-card,
        .tab-navigation,
        .tab-btn,
        .list-item,
        .item-header,
        .item-title,
        .item-subtitle,
        .status-badge,
        .settings-section,
        .section-title,
        .form-input[readonly],
        .form-input:not(input):not(textarea),
        .modal-title,
        .empty-state,
        .empty-title,
        .empty-text,
        .loading-text,
        .notification {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        input, textarea {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        
        .status-bar {
            height: env(safe-area-inset-top, 0px);
            background: var(--primary-color);
        }
        
        .admin-container {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .admin-header {
            background: var(--primary-color);
            color: white;
            padding: 12px 16px;
            box-shadow: var(--shadow);
            z-index: 100;
            flex-shrink: 0;
        }
        
        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        .header-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }
        
        .header-text h1 {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .header-text p {
            font-size: 0.75rem;
            opacity: 0.8;
        }
        
        .header-actions {
            display: flex;
            gap: 8px;
        }
        
        .icon-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .icon-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            padding: 12px 16px;
            background: white;
            flex-shrink: 0;
        }
        
        .stat-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }
        
        .stat-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        .stat-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }
        
        .stat-icon.total { background: rgba(33, 150, 243, 0.1); color: var(--info-color); }
        .stat-icon.active { background: rgba(76, 175, 80, 0.1); color: var(--success-color); }
        .stat-icon.pending { background: rgba(255, 152, 0, 0.1); color: var(--warning-color); }
        .stat-icon.blocked { background: rgba(244, 67, 54, 0.1); color: var(--danger-color); }
        .stat-icon.expired { background: rgba(96, 125, 139, 0.1); color: #607d8b; }
        .stat-icon.revenue { background: rgba(156, 39, 176, 0.1); color: #9c27b0; }
        
        .stat-number {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .tab-navigation {
            display: flex;
            background: white;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
            padding: 0 16px;
        }
        
        .tab-btn {
            flex: 1;
            padding: 14px 0;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.9rem;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
        }
        
        .tab-btn.active {
            color: var(--primary-color);
        }
        
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-color);
            border-radius: 3px 3px 0 0;
        }
        
        .main-content {
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        
        .tab-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 16px;
            display: none;
            background: var(--light-bg);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .search-bar {
            margin-bottom: 16px;
        }
        
        .search-container {
            background: white;
            border-radius: 10px;
            padding: 0 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
        }
        
        .search-container i {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .search-container input {
            flex: 1;
            padding: 12px 0;
            border: none;
            outline: none;
            font-size: 0.9rem;
            background: transparent;
        }
        
        .list-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .list-item {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .list-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .item-title {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .item-subtitle {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 2px;
        }
        
        .item-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .detail-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .detail-value {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
            text-align: center;
        }
        
        .status-active, .status-approved { background: rgba(76, 175, 80, 0.1); color: var(--success-color); }
        .status-pending { background: rgba(255, 152, 0, 0.1); color: var(--warning-color); }
        .status-blocked, .status-rejected { background: rgba(244, 67, 54, 0.1); color: var(--danger-color); }
        .status-expired { background: rgba(96, 125, 139, 0.1); color: #607d8b; }
        .status-renewal-pending { background: rgba(33, 150, 243, 0.1); color: var(--info-color); }
        
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        
        .action-btn {
            padding: 10px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .btn-view { background: rgba(33, 150, 243, 0.1); color: var(--info-color); }
        .btn-activate, .btn-approve { background: rgba(76, 175, 80, 0.1); color: var(--success-color); }
        .btn-block, .btn-reject { background: rgba(244, 67, 54, 0.1); color: var(--danger-color); }
        .btn-delete { background: rgba(33, 33, 33, 0.1); color: var(--primary-color); }
        .btn-whatsapp { background: rgba(37, 211, 102, 0.1); color: #25D366; }
        
        .action-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .settings-section {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }
        
        .section-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--primary-color);
            color: var(--text-primary);
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.85rem;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            background: white;
            color: var(--text-primary);
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(33, 33, 33, 0.1);
        }
        
        .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.9rem;
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }
        
        .form-hint {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 4px;
            display: block;
        }
        
        .submit-btn {
            width: 100%;
            padding: 14px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .submit-btn:hover {
            background: #000;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        
        .empty-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            color: #e0e0e0;
        }
        
        .empty-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }
        
        .empty-text {
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s ease;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        .fab:hover,
        .fab:active,
        .fab:focus {
            transform: scale(1.05);
            background: #000;
            outline: none;
        }
        
        .image-viewer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: center;
            touch-action: pan-x pan-y;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .image-viewer-container {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .image-viewer-img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transform-origin: 0 0;
            transition: transform 0.1s ease-out;
            cursor: grab;
            touch-action: pan-x pan-y;
        }
        
        .image-viewer-img:active {
            cursor: grabbing;
        }
        
        .image-viewer-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 10001;
        }
        
        .image-viewer-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.2s ease;
        }
        
        .image-viewer-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .image-viewer-zoom-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            color: white;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
        }
        
        .receipt-preview-container {
            position: relative;
            width: 100%;
            height: 300px;
            border-radius: 12px;
            overflow: hidden;
            background: #f8f9fa;
            margin-bottom: 16px;
            border: 2px solid var(--border-color);
            touch-action: pan-x pan-y;
        }
        
        .receipt-preview-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.3s ease;
        }
        
        .modal-header {
            padding: 20px 20px 12px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            line-height: 1;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .confirmation-text {
            padding: 12px;
            border: 2px solid var(--danger-color);
            border-radius: 8px;
            background: rgba(244, 67, 54, 0.05);
            margin-bottom: 20px;
            font-size: 0.9rem;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 16px;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .loading-text {
            color: white;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 16px 24px;
            border-radius: 12px;
            background: var(--primary-color);
            color: white;
            font-weight: 500;
            text-align: center;
            z-index: 4000;
            animation: fadeIn 0.3s ease;
            max-width: 280px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .notification.success { background: var(--success-color); }
        .notification.error { background: var(--danger-color); }
        .notification.info { background: var(--info-color); }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .mt-1 { margin-top: 8px; }
        .mt-2 { margin-top: 16px; }
        .mb-1 { margin-bottom: 8px; }
        .mb-2 { margin-bottom: 16px; }
        .text-center { text-align: center; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 8px; }
        
        @media (max-width: 360px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="status-bar"></div>
    
    <div class="image-viewer-overlay" id="imageViewer">
        <div class="image-viewer-container">
            <img class="image-viewer-img" id="imageViewerImg" alt="Comprovante">
            <div class="image-viewer-controls">
                <button class="image-viewer-btn" id="imageViewerZoomIn">
                    <i class="fas fa-search-plus"></i>
                </button>
                <button class="image-viewer-btn" id="imageViewerZoomOut">
                    <i class="fas fa-search-minus"></i>
                </button>
                <button class="image-viewer-btn" id="imageViewerReset">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button class="image-viewer-btn" id="imageViewerClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="image-viewer-zoom-info" id="imageViewerZoomInfo">100%</div>
        </div>
    </div>
    
    <div class="admin-container">
        <header class="admin-header">
            <div class="header-top">
                <div class="header-title">
                    <div class="header-icon">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <div class="header-text">
                        <h1>Admin Venda+</h1>
                        <p>Painel de Controle</p>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="icon-btn" id="refreshBtn" title="Atualizar">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
        </header>
        
        <div class="stats-grid" id="statsGrid"></div>
        
        <div class="tab-navigation">
            <button class="tab-btn active" data-tab="users">
                <i class="fas fa-users"></i> Usu√°rios
            </button>
            <button class="tab-btn" data-tab="payments">
                <i class="fas fa-money-bill"></i> Pagamentos
            </button>
            <button class="tab-btn" data-tab="settings">
                <i class="fas fa-cog"></i> Configura√ß√µes
            </button>
        </div>
        
        <div class="main-content">
            <div id="usersTab" class="tab-content active">
                <div class="search-bar">
                    <div class="search-container">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchUsers" placeholder="Buscar usu√°rios...">
                    </div>
                </div>
                
                <div class="list-container" id="usersList"></div>
                
                <div class="empty-state" id="usersEmpty" style="display: none;">
                    <div class="empty-icon">
                        <i class="fas fa-users-slash"></i>
                    </div>
                    <div class="empty-title">Nenhum usu√°rio encontrado</div>
                    <div class="empty-text">Os usu√°rios cadastrados aparecer√£o aqui</div>
                </div>
            </div>
            
            <div id="paymentsTab" class="tab-content">
                <div class="search-bar">
                    <div class="search-container">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchPayments" placeholder="Buscar pagamentos...">
                    </div>
                </div>
                
                <div class="list-container" id="paymentsList"></div>
                
                <div class="empty-state" id="paymentsEmpty" style="display: none;">
                    <div class="empty-icon">
                        <i class="fas fa-file-invoice-dollar"></i>
                    </div>
                    <div class="empty-title">Nenhum pagamento encontrado</div>
                    <div class="empty-text">Os pagamentos aparecer√£o aqui</div>
                </div>
            </div>
            
            <div id="settingsTab" class="tab-content">
                <div class="settings-section">
                    <h2 class="section-title">Configura√ß√µes de Pagamento</h2>
                    
                    <form id="paymentSettingsForm">
                        <div class="form-group">
                            <label class="form-label">Chave PIX Padr√£o</label>
                            <input type="text" id="pixKey" class="form-input" placeholder="Chave PIX para recebimentos" required>
                            <span class="form-hint">Esta chave PIX ser√° exibida para todos os usu√°rios</span>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">WhatsApp para Notifica√ß√µes</label>
                            <input type="text" id="adminWhatsApp" class="form-input" placeholder="(11) 99999-9999" required>
                            <span class="form-hint">N√∫mero que receber√° notifica√ß√µes de novos pagamentos</span>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Valor do Plano Mensal (R$)</label>
                            <input type="number" id="monthlyPlanPrice" class="form-input" step="0.01" min="0" value="99.00" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Dias para Notifica√ß√£o de Vencimento</label>
                            <input type="number" id="expirationWarningDays" class="form-input" min="1" max="30" value="7" required>
                            <span class="form-hint">Dias antes do vencimento para notificar o usu√°rio</span>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Mensagem de Notifica√ß√£o WhatsApp</label>
                            <textarea id="whatsappMessage" class="form-textarea" rows="5">
üì± *NOVO PAGAMENTO PENDENTE* üì±

üë§ *Cliente:* {nome}
üè™ *Loja:* {loja}
üìß *E-mail:* {email}
üì± *Telefone:* {telefone}
üíµ *Plano:* Mensal
üí∞ *Valor:* R$ {valor}
üìÖ *Data:* {data}

‚ö†Ô∏è *Status:* Aguardando confirma√ß√£o

Por favor, acesse o painel administrativo para verificar o comprovante e liberar o acesso.</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Mensagem de Pagamento Aprovado (para cliente)</label>
                            <textarea id="paymentApprovedMessage" class="form-textarea" rows="5">
‚úÖ *PAGAMENTO APROVADO!* ‚úÖ

Ol√° {nome}! üëã

Seu pagamento foi *APROVADO* com sucesso! üéâ

üè™ *Loja:* {loja}
üíµ *Plano:* {plano}
üìÖ *V√°lido at√©:* {validade}
üí∞ *Valor:* R$ {valor}

Agora voc√™ j√° pode acessar sua conta e come√ßar a usar todas as funcionalidades do Venda+!

üîó *Acesse:* https://seusite.com/login

Em caso de d√∫vidas, estamos √† disposi√ß√£o!

Atenciosamente,
Equipe Venda+ üì±</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Mensagem de Pagamento Rejeitado (para cliente)</label>
                            <textarea id="paymentRejectedMessage" class="form-textarea" rows="5">
‚ùå *PAGAMENTO REJEITADO* ‚ùå

Ol√° {nome},

Lamentamos informar que seu pagamento foi *REJEITADO*.

üè™ *Loja:* {loja}
üíµ *Plano:* {plano}
üí∞ *Valor:* R$ {valor}
üìÖ *Data:* {data}

üìã *Motivo:* Comprovante n√£o identificado ou informa√ß√µes inconsistentes.

üîç *O que fazer:*
1. Verifique se o comprovante est√° leg√≠vel
2. Confirme se os dados est√£o corretos
3. Envie novamente o comprovante

Para mais informa√ß√µes, entre em contato conosco.

Atenciosamente,
Equipe Venda+ üì±</textarea>
                        </div>
                        
                        <button type="submit" class="submit-btn">
                            <i class="fas fa-save"></i> Salvar Configura√ß√µes
                        </button>
                    </form>
                </div>
                
                <div class="settings-section">
                    <h2 class="section-title">Sistema</h2>
                    
                    <div class="form-group">
                        <label class="form-label">Admin Logado</label>
                        <div class="form-input" style="background: #f8f9fa;">
                            <div id="adminInfo"></div>
                        </div>
                    </div>
                    
                    <button class="submit-btn" id="clearCacheBtn">
                        <i class="fas fa-trash"></i> Limpar Cache
                    </button>
                </div>
            </div>
        </div>
        
        <button class="fab" id="newUserBtn" title="Novo Usu√°rio">
            <i class="fas fa-user-plus"></i>
        </button>
    </div>
    
    <div class="modal" id="userDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Detalhes do Usu√°rio</h2>
                <button class="modal-close" id="closeUserModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="userDetailsContent"></div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="paymentDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Detalhes do Pagamento</h2>
                <button class="modal-close" id="closePaymentModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="paymentDetailsContent"></div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="newUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Novo Usu√°rio</h2>
                <button class="modal-close" id="closeNewUserModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="newUserForm">
                    <div class="form-group">
                        <label class="form-label">Nome da Loja *</label>
                        <input type="text" id="newStoreName" class="form-input" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">E-mail *</label>
                        <input type="email" id="newUserEmail" class="form-input" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Senha *</label>
                        <input type="password" id="newUserPassword" class="form-input" required minlength="6">
                        <span class="form-hint">M√≠nimo 6 caracteres</span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Telefone (WhatsApp) *</label>
                        <input type="text" id="newUserPhone" class="form-input" placeholder="(11) 99999-9999" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Plano</label>
                        <select id="newUserPlan" class="form-input">
                            <option value="monthly">Mensal (30 dias)</option>
                            <option value="custom">Personalizado</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="customDaysGroup" style="display: none;">
                        <label class="form-label">Dias de Plano Personalizado *</label>
                        <input type="number" id="customPlanDays" class="form-input" min="1" max="365" value="30" placeholder="Digite o n√∫mero de dias">
                        <span class="form-hint">Digite a quantidade de dias que o plano ter√° (1-365)</span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select id="newUserStatus" class="form-input">
                            <option value="active">Ativo</option>
                            <option value="pending">Pendente</option>
                            <option value="blocked">Bloqueado</option>
                        </select>
                    </div>
                    
                    <div class="flex gap-2 mt-2">
                        <button type="button" class="submit-btn" style="background: #757575;" id="cancelNewUserBtn">
                            Cancelar
                        </button>
                        <button type="submit" class="submit-btn">
                            <i class="fas fa-user-plus"></i> Criar Usu√°rio
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="modal" id="deleteConfirmationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Confirmar Exclus√£o</h2>
                <button class="modal-close" id="closeDeleteModal">&times;</button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir este pagamento?</p>
                <div class="confirmation-text">
                    <strong>Digite "CONFIRMAR" para excluir:</strong>
                    <input type="text" id="confirmationInput" class="form-input mt-1" placeholder="Digite CONFIRMAR">
                </div>
                <div class="flex gap-2 mt-2">
                    <button type="button" class="submit-btn" style="background: #757575;" id="cancelDeleteBtn">
                        Cancelar
                    </button>
                    <button type="button" class="submit-btn" style="background: var(--danger-color);" id="confirmDeleteBtn" disabled>
                        <i class="fas fa-trash"></i> Excluir
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Carregando...</div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB7U-JfKAlkPxSyL4AEf5u0BgcDzSXf41M",
            authDomain: "appvendas-1eebf.firebaseapp.com",
            projectId: "appvendas-1eebf",
            storageBucket: "appvendas-1eebf.firebasestorage.app",
            messagingSenderId: "229472373918",
            appId: "1:229472373918:web:39cd4940b052b2375f3f8f"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let adminUser = null;
        let users = [];
        let payments = [];
        let systemConfig = {};
        let currentPaymentToDelete = null;
        
        let imageViewerScale = 1;
        let imageViewerTranslateX = 0;
        let imageViewerTranslateY = 0;
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;

        const refreshBtn = document.getElementById('refreshBtn');
        const newUserBtn = document.getElementById('newUserBtn');
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        const statsGrid = document.getElementById('statsGrid');
        const usersList = document.getElementById('usersList');
        const usersEmpty = document.getElementById('usersEmpty');
        const paymentsList = document.getElementById('paymentsList');
        const paymentsEmpty = document.getElementById('paymentsEmpty');
        const searchUsers = document.getElementById('searchUsers');
        const searchPayments = document.getElementById('searchPayments');
        const adminInfo = document.getElementById('adminInfo');
        const clearCacheBtn = document.getElementById('clearCacheBtn');
        
        const imageViewer = document.getElementById('imageViewer');
        const imageViewerImg = document.getElementById('imageViewerImg');
        const imageViewerZoomIn = document.getElementById('imageViewerZoomIn');
        const imageViewerZoomOut = document.getElementById('imageViewerZoomOut');
        const imageViewerReset = document.getElementById('imageViewerReset');
        const imageViewerClose = document.getElementById('imageViewerClose');
        const imageViewerZoomInfo = document.getElementById('imageViewerZoomInfo');
        
        const paymentSettingsForm = document.getElementById('paymentSettingsForm');
        const pixKeyInput = document.getElementById('pixKey');
        const adminWhatsAppInput = document.getElementById('adminWhatsApp');
        const monthlyPlanPriceInput = document.getElementById('monthlyPlanPrice');
        const expirationWarningDaysInput = document.getElementById('expirationWarningDays');
        const whatsappMessageInput = document.getElementById('whatsappMessage');
        const paymentApprovedMessageInput = document.getElementById('paymentApprovedMessage');
        const paymentRejectedMessageInput = document.getElementById('paymentRejectedMessage');
        
        const newUserForm = document.getElementById('newUserForm');
        const newUserPlanSelect = document.getElementById('newUserPlan');
        const customDaysGroup = document.getElementById('customDaysGroup');
        const customPlanDaysInput = document.getElementById('customPlanDays');
        
        const userDetailsModal = document.getElementById('userDetailsModal');
        const closeUserModal = document.getElementById('closeUserModal');
        const paymentDetailsModal = document.getElementById('paymentDetailsModal');
        const closePaymentModal = document.getElementById('closePaymentModal');
        const newUserModal = document.getElementById('newUserModal');
        const closeNewUserModal = document.getElementById('closeNewUserModal');
        const cancelNewUserBtn = document.getElementById('cancelNewUserBtn');
        const deleteConfirmationModal = document.getElementById('deleteConfirmationModal');
        const closeDeleteModal = document.getElementById('closeDeleteModal');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const confirmationInput = document.getElementById('confirmationInput');
        
        const loadingOverlay = document.getElementById('loadingOverlay');

        async function init() {
            await checkAdminAuth();
            await loadSystemConfig();
            await loadAllUsers();
            await loadAllPayments();
            setupEventListeners();
            setupImageViewer();
            updateStats();
            updateAdminInfo();
        }

        function setupImageViewer() {
            imageViewerZoomIn.addEventListener('click', () => zoomImageViewer(1.2));
            imageViewerZoomOut.addEventListener('click', () => zoomImageViewer(0.8));
            imageViewerReset.addEventListener('click', resetImageViewer);
            imageViewerClose.addEventListener('click', () => imageViewer.style.display = 'none');
            
            imageViewerImg.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? 0.8 : 1.2;
                zoomImageViewer(delta, e.clientX, e.clientY);
            });
            
            imageViewerImg.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', doDrag);
            document.addEventListener('mouseup', stopDrag);
            
            imageViewerImg.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (e.touches.length === 1) {
                    startDrag({
                        clientX: e.touches[0].clientX,
                        clientY: e.touches[0].clientY
                    });
                }
            });
            
            imageViewerImg.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (e.touches.length === 1) {
                    doDrag({
                        clientX: e.touches[0].clientX,
                        clientY: e.touches[0].clientY
                    });
                }
            });
            
            imageViewerImg.addEventListener('touchend', (e) => {
                e.preventDefault();
                stopDrag();
            });
            
            imageViewerImg.addEventListener('dblclick', resetImageViewer);
        }
        
        function openImageViewer(imageSrc) {
            imageViewerImg.src = imageSrc;
            imageViewer.style.display = 'flex';
            resetImageViewer();
        }
        
        function zoomImageViewer(factor, centerX, centerY) {
            const oldScale = imageViewerScale;
            imageViewerScale *= factor;
            
            if (imageViewerScale < 0.1) imageViewerScale = 0.1;
            if (imageViewerScale > 5) imageViewerScale = 5;
            
            if (centerX !== undefined && centerY !== undefined) {
                const containerRect = imageViewer.getBoundingClientRect();
                const relativeX = centerX - containerRect.left;
                const relativeY = centerY - containerRect.top;
                
                imageViewerTranslateX = relativeX - (relativeX - imageViewerTranslateX) * (imageViewerScale / oldScale);
                imageViewerTranslateY = relativeY - (relativeY - imageViewerTranslateY) * (imageViewerScale / oldScale);
            }
            
            updateImageViewerTransform();
        }
        
        function resetImageViewer() {
            imageViewerScale = 1;
            imageViewerTranslateX = 0;
            imageViewerTranslateY = 0;
            updateImageViewerTransform();
        }
        
        function updateImageViewerTransform() {
            imageViewerImg.style.transform = `translate(${imageViewerTranslateX}px, ${imageViewerTranslateY}px) scale(${imageViewerScale})`;
            imageViewerZoomInfo.textContent = `${Math.round(imageViewerScale * 100)}%`;
        }
        
        function startDrag(e) {
            isDragging = true;
            dragStartX = e.clientX - imageViewerTranslateX;
            dragStartY = e.clientY - imageViewerTranslateY;
            imageViewerImg.style.cursor = 'grabbing';
        }
        
        function doDrag(e) {
            if (!isDragging) return;
            
            imageViewerTranslateX = e.clientX - dragStartX;
            imageViewerTranslateY = e.clientY - dragStartY;
            
            const containerRect = imageViewer.getBoundingClientRect();
            const imgRect = imageViewerImg.getBoundingClientRect();
            
            const maxX = Math.max(0, (imgRect.width * imageViewerScale - containerRect.width) / 2);
            const maxY = Math.max(0, (imgRect.height * imageViewerScale - containerRect.height) / 2);
            
            if (imageViewerScale > 1) {
                imageViewerTranslateX = Math.max(-maxX, Math.min(maxX, imageViewerTranslateX));
                imageViewerTranslateY = Math.max(-maxY, Math.min(maxY, imageViewerTranslateY));
            }
            
            updateImageViewerTransform();
        }
        
        function stopDrag() {
            isDragging = false;
            imageViewerImg.style.cursor = 'grab';
        }

        async function checkAdminAuth() {
            try {
                const adminSession = localStorage.getItem('adminSession');
                if (!adminSession) {
                    redirectToLogin();
                    return;
                }
                
                const sessionData = JSON.parse(adminSession);
                adminUser = sessionData;
                
                const sessionAge = new Date() - new Date(sessionData.timestamp);
                const maxAge = 8 * 60 * 60 * 1000;
                
                if (sessionAge > maxAge) {
                    localStorage.removeItem('adminSession');
                    showNotification('Sess√£o expirada. Fa√ßa login novamente.', 'error');
                    setTimeout(() => {
                        redirectToLogin();
                    }, 2000);
                    return;
                }
                
                try {
                    const user = auth.currentUser;
                    if (user && user.email !== adminUser.email) {
                        adminUser = {
                            uid: user.uid,
                            email: user.email,
                            name: user.displayName,
                            photoURL: user.photoURL,
                            loggedIn: true,
                            timestamp: new Date().toISOString()
                        };
                        localStorage.setItem('adminSession', JSON.stringify(adminUser));
                    }
                } catch (authError) {
                    console.log('Auth check skipped:', authError);
                }
                
            } catch (error) {
                console.error('Admin auth error:', error);
                localStorage.removeItem('adminSession');
                redirectToLogin();
            }
        }

        function redirectToLogin() {
            showNotification('Acesso n√£o autorizado. Redirecionando para login...', 'error');
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 1500);
        }

        function updateAdminInfo() {
            if (!adminUser) return;
            
            adminInfo.innerHTML = `
                <div class="flex items-center gap-2">
                    ${adminUser.photoURL ? 
                        `<img src="${adminUser.photoURL}" alt="${adminUser.name}" style="width: 24px; height: 24px; border-radius: 50%;">` : 
                        `<i class="fas fa-user" style="color: #757575;"></i>`
                    }
                    <div>
                        <div style="font-weight: 600;">${adminUser.name || 'Administrador'}</div>
                        <div style="font-size: 0.8rem; color: #757575;">${adminUser.email}</div>
                    </div>
                </div>
            `;
        }

        async function loadSystemConfig() {
            try {
                const configDoc = await db.collection('systemConfig').doc('paymentSettings').get();
                if (configDoc.exists) {
                    systemConfig = configDoc.data();
                    updateSettingsForm();
                } else {
                    systemConfig = {
                        pixKey: 'chave-pix@empresa.com',
                        adminWhatsApp: '(11) 99999-9999',
                        monthlyPlanPrice: 99.00,
                        expirationWarningDays: 7,
                        whatsappMessage: whatsappMessageInput.value,
                        paymentApprovedMessage: paymentApprovedMessageInput.value,
                        paymentRejectedMessage: paymentRejectedMessageInput.value,
                        updatedAt: new Date().toISOString()
                    };
                    await db.collection('systemConfig').doc('paymentSettings').set(systemConfig);
                    updateSettingsForm();
                }
            } catch (error) {
                console.error('Error loading system config:', error);
                showNotification('Configura√ß√µes carregadas com padr√µes.', 'info');
            }
        }

        function updateSettingsForm() {
            if (pixKeyInput) pixKeyInput.value = systemConfig.pixKey || '';
            if (adminWhatsAppInput) adminWhatsAppInput.value = systemConfig.adminWhatsApp || '';
            if (monthlyPlanPriceInput) monthlyPlanPriceInput.value = systemConfig.monthlyPlanPrice || 99.00;
            if (expirationWarningDaysInput) expirationWarningDaysInput.value = systemConfig.expirationWarningDays || 7;
            if (whatsappMessageInput) whatsappMessageInput.value = systemConfig.whatsappMessage || '';
            if (paymentApprovedMessageInput) paymentApprovedMessageInput.value = systemConfig.paymentApprovedMessage || '';
            if (paymentRejectedMessageInput) paymentRejectedMessageInput.value = systemConfig.paymentRejectedMessage || '';
        }

        async function loadAllUsers() {
            try {
                showLoading();
                const snapshot = await db.collection('users').get();
                
                users = [];
                snapshot.forEach(doc => {
                    const userData = doc.data();
                    users.push({
                        id: doc.id,
                        ...userData
                    });
                });
                
                users.sort((a, b) => {
                    return new Date(b.createdAt || b.timestamp) - new Date(a.createdAt || a.timestamp);
                });
                
                updateUsersList();
                updateStats();
                hideLoading();
            } catch (error) {
                console.error('Error loading users:', error);
                showNotification('Erro ao carregar usu√°rios.', 'error');
                hideLoading();
            }
        }

        async function loadAllPayments() {
            try {
                const snapshot = await db.collection('payments').orderBy('createdAt', 'desc').get();
                
                payments = [];
                snapshot.forEach(doc => {
                    const paymentData = doc.data();
                    payments.push({
                        id: doc.id,
                        ...paymentData
                    });
                });
                
                updatePaymentsList();
            } catch (error) {
                console.error('Error loading payments:', error);
                showNotification('Erro ao carregar pagamentos.', 'error');
            }
        }

        function updateStats() {
            const totalUsers = users.length;
            const activeUsers = users.filter(user => user.status === 'active').length;
            const pendingUsers = users.filter(user => user.status === 'pending').length;
            const blockedUsers = users.filter(user => user.status === 'blocked').length;
            const expiredUsers = users.filter(user => user.status === 'expired').length;
            const renewalPendingUsers = users.filter(user => user.renewalStatus === 'pending').length;
            const monthlyRevenue = activeUsers * (systemConfig.monthlyPlanPrice || 99);
            
            const stats = [
                { icon: 'users', label: 'Total', value: totalUsers, color: 'total' },
                { icon: 'check-circle', label: 'Ativos', value: activeUsers, color: 'active' },
                { icon: 'clock', label: 'Pendentes', value: pendingUsers, color: 'pending' },
                { icon: 'ban', label: 'Bloqueados', value: blockedUsers, color: 'blocked' },
                { icon: 'calendar-times', label: 'Expirados', value: expiredUsers, color: 'expired' },
                { icon: 'sync-alt', label: 'Renova√ß√µes Pendentes', value: renewalPendingUsers, color: 'revenue' }
            ];
            
            statsGrid.innerHTML = '';
            stats.forEach(stat => {
                const statCard = document.createElement('div');
                statCard.className = 'stat-card';
                statCard.innerHTML = `
                    <div class="stat-row">
                        <div class="stat-icon ${stat.color}">
                            <i class="fas fa-${stat.icon}"></i>
                        </div>
                        <div class="stat-number">${stat.value}</div>
                    </div>
                    <div class="stat-label">${stat.label}</div>
                `;
                statsGrid.appendChild(statCard);
            });
        }

        function updateUsersList() {
            usersList.innerHTML = '';
            
            if (users.length === 0) {
                usersEmpty.style.display = 'block';
                return;
            }
            
            usersEmpty.style.display = 'none';
            
            const searchTerm = searchUsers.value.toLowerCase();
            
            users.forEach(user => {
                if (searchTerm && 
                    !user.storeName?.toLowerCase().includes(searchTerm) &&
                    !user.email?.toLowerCase().includes(searchTerm)) {
                    return;
                }
                
                let status = user.status || 'pending';
                const renewalStatus = user.renewalStatus || 'none';
                
                // Se o usu√°rio tem renova√ß√£o pendente, mostramos esse status
                if (renewalStatus === 'pending' || renewalStatus === 'pending_approval') {
                    status = 'renewal_pending';
                }
                
                const expiryDate = user.expiryDate || 'N√£o definida';
                const phone = user.phone || 'N√£o informado';
                
                const statusText = getStatusText(status, renewalStatus);
                const statusClass = getStatusClass(status, renewalStatus);
                
                const userItem = document.createElement('div');
                userItem.className = 'list-item';
                userItem.setAttribute('data-user-id', user.id);
                userItem.innerHTML = `
                    <div class="item-header">
                        <div>
                            <div class="item-title">${user.storeName || 'Sem nome'}</div>
                            <div class="item-subtitle">${user.email}</div>
                            <div class="item-subtitle">${phone}</div>
                            ${renewalStatus === 'pending' || renewalStatus === 'pending_approval' ? 
                                `<div class="item-subtitle" style="color: var(--info-color); font-weight: 500;">
                                    <i class="fas fa-sync-alt"></i> Renova√ß√£o pendente
                                </div>` : ''
                            }
                        </div>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </div>
                    
                    <div class="item-details">
                        <div class="detail-item">
                            <span class="detail-label">Status</span>
                            <span class="detail-value">${statusText}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Expira em</span>
                            <span class="detail-value">${expiryDate}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Plano</span>
                            <span class="detail-value">${user.plan === 'monthly' ? 'Mensal' : user.plan === 'custom' ? 'Personalizado' : user.plan}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Cadastro</span>
                            <span class="detail-value">${formatDate(user.createdAt)}</span>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="action-btn btn-view" data-id="${user.id}" data-action="view">
                            <i class="fas fa-eye"></i> Ver
                        </button>
                        ${status === 'active' || status === 'renewal_pending' ? `
                            <button class="action-btn btn-block" data-id="${user.id}" data-action="block">
                                <i class="fas fa-ban"></i> Bloquear
                            </button>
                        ` : `
                            <button class="action-btn btn-activate" data-id="${user.id}" data-action="activate">
                                <i class="fas fa-check"></i> Ativar
                            </button>
                        `}
                    </div>
                `;
                
                usersList.appendChild(userItem);
                
                userItem.addEventListener('click', (e) => {
                    if (e.target.closest('.action-btn')) return;
                    const userId = e.currentTarget.getAttribute('data-user-id');
                    viewUserDetails(userId);
                });
            });
            
            usersList.querySelectorAll('[data-action="view"]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const userId = e.currentTarget.getAttribute('data-id');
                    viewUserDetails(userId);
                });
            });
            
            usersList.querySelectorAll('[data-action="block"]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const userId = e.currentTarget.getAttribute('data-id');
                    toggleUserStatus(userId, 'blocked');
                });
            });
            
            usersList.querySelectorAll('[data-action="activate"]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const userId = e.currentTarget.getAttribute('data-id');
                    toggleUserStatus(userId, 'active');
                });
            });
        }

        function updatePaymentsList() {
            paymentsList.innerHTML = '';
            
            if (payments.length === 0) {
                paymentsEmpty.style.display = 'block';
                return;
            }
            
            paymentsEmpty.style.display = 'none';
            
            const searchTerm = searchPayments.value.toLowerCase();
            
            payments.forEach(payment => {
                if (searchTerm && 
                    !payment.userName?.toLowerCase().includes(searchTerm) &&
                    !payment.storeName?.toLowerCase().includes(searchTerm) &&
                    !payment.userEmail?.toLowerCase().includes(searchTerm)) {
                    return;
                }
                
                const status = payment.status || 'pending';
                const statusText = getPaymentStatusText(status);
                const statusClass = getPaymentStatusClass(status);
                const paymentType = payment.type === 'renewal' ? 'üîÑ Renova√ß√£o' : 'üìã Novo';
                
                const paymentItem = document.createElement('div');
                paymentItem.className = 'list-item';
                paymentItem.setAttribute('data-payment-id', payment.id);
                paymentItem.innerHTML = `
                    <div class="item-header">
                        <div>
                            <div class="item-title">${payment.userName || 'Nome n√£o informado'} ${paymentType}</div>
                            <div class="item-subtitle">${payment.storeName || 'Sem nome'}</div>
                            <div class="item-subtitle">${payment.userEmail}</div>
                        </div>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </div>
                    
                    <div class="item-details">
                        <div class="detail-item">
                            <span class="detail-label">Tipo</span>
                            <span class="detail-value">${paymentType}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Valor</span>
                            <span class="detail-value">R$ ${payment.amount?.toFixed(2).replace('.', ',') || '0,00'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Data</span>
                            <span class="detail-value">${formatDate(payment.createdAt)}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Telefone</span>
                            <span class="detail-value">${payment.userPhone || 'N√£o informado'}</span>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="action-btn btn-view" data-id="${payment.id}" data-action="view">
                            <i class="fas fa-eye"></i> Ver
                        </button>
                        ${status === 'pending' || status === 'pending_approval' ? `
                            <button class="action-btn btn-approve" data-id="${payment.id}" data-action="approve">
                                <i class="fas fa-check"></i> Aprovar
                            </button>
                            <button class="action-btn btn-reject" data-id="${payment.id}" data-action="reject">
                                <i class="fas fa-times"></i> Rejeitar
                            </button>
                        ` : `
                            <button class="action-btn btn-whatsapp" data-id="${payment.id}" data-action="whatsapp">
                                <i class="fas fa-whatsapp"></i> WhatsApp
                            </button>
                            <button class="action-btn btn-delete" data-id="${payment.id}" data-action="delete">
                                <i class="fas fa-trash"></i> Excluir
                            </button>
                        `}
                    </div>
                `;
                
                paymentsList.appendChild(paymentItem);
                
                paymentItem.addEventListener('click', (e) => {
                    if (e.target.closest('.action-btn')) return;
                    const paymentId = e.currentTarget.getAttribute('data-payment-id');
                    viewPaymentDetails(paymentId);
                });
            });
            
            paymentsList.querySelectorAll('[data-action="view"]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const paymentId = e.currentTarget.getAttribute('data-id');
                    viewPaymentDetails(paymentId);
                });
            });
            
            paymentsList.querySelectorAll('[data-action="approve"]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const paymentId = e.currentTarget.getAttribute('data-id');
                    approvePayment(paymentId);
                });
            });
            
            paymentsList.querySelectorAll('[data-action="reject"]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const paymentId = e.currentTarget.getAttribute('data-id');
                    rejectPayment(paymentId);
                });
            });
            
            paymentsList.querySelectorAll('[data-action="delete"]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const paymentId = e.currentTarget.getAttribute('data-id');
                    showDeleteConfirmation(paymentId);
                });
            });
            
            paymentsList.querySelectorAll('[data-action="whatsapp"]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const paymentId = e.currentTarget.getAttribute('data-id');
                    sendWhatsAppMessage(paymentId);
                });
            });
        }

        function setupEventListeners() {
            refreshBtn.addEventListener('click', async () => {
                await loadAllUsers();
                await loadAllPayments();
                showNotification('Dados atualizados!', 'success');
            });
            
            newUserBtn.addEventListener('click', () => {
                newUserModal.style.display = 'flex';
                setTimeout(() => {
                    document.getElementById('newStoreName')?.focus();
                }, 300);
            });
            
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabId = btn.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            searchUsers.addEventListener('input', updateUsersList);
            searchPayments.addEventListener('input', updatePaymentsList);
            paymentSettingsForm.addEventListener('submit', saveSystemConfig);
            clearCacheBtn.addEventListener('click', clearCache);
            
            closeUserModal.addEventListener('click', () => userDetailsModal.style.display = 'none');
            closePaymentModal.addEventListener('click', () => paymentDetailsModal.style.display = 'none');
            closeNewUserModal.addEventListener('click', closeNewUser);
            cancelNewUserBtn.addEventListener('click', closeNewUser);
            closeDeleteModal.addEventListener('click', closeDeleteModalHandler);
            cancelDeleteBtn.addEventListener('click', closeDeleteModalHandler);
            
            newUserForm.addEventListener('submit', createNewUser);
            
            newUserPlanSelect.addEventListener('change', function() {
                customDaysGroup.style.display = this.value === 'custom' ? 'block' : 'none';
            });
            
            window.addEventListener('click', (e) => {
                if (e.target === userDetailsModal) userDetailsModal.style.display = 'none';
                if (e.target === paymentDetailsModal) paymentDetailsModal.style.display = 'none';
                if (e.target === newUserModal) closeNewUser();
                if (e.target === deleteConfirmationModal) closeDeleteModalHandler();
                if (e.target === imageViewer) imageViewer.style.display = 'none';
            });
            
            confirmationInput.addEventListener('input', function() {
                confirmDeleteBtn.disabled = this.value !== 'CONFIRMAR';
            });
            
            confirmDeleteBtn.addEventListener('click', deletePayment);
            
            if (adminWhatsAppInput) {
                new IMask(adminWhatsAppInput, {
                    mask: '(00) 00000-0000',
                    lazy: false
                });
            }
        }

        function closeNewUser() {
            newUserModal.style.display = 'none';
            newUserForm.reset();
            customDaysGroup.style.display = 'none';
        }

        function closeDeleteModalHandler() {
            deleteConfirmationModal.style.display = 'none';
            resetDeleteConfirmation();
        }

        function resetDeleteConfirmation() {
            confirmationInput.value = '';
            confirmDeleteBtn.disabled = true;
            currentPaymentToDelete = null;
        }

        function switchTab(tabId) {
            tabBtns.forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-tab') === tabId);
            });
            
            tabContents.forEach(content => {
                content.classList.toggle('active', content.id === `${tabId}Tab`);
            });
        }

        async function viewUserDetails(userId) {
            const user = users.find(user => user.id === userId);
            if (!user) return;
            
            let status = user.status || 'pending';
            const renewalStatus = user.renewalStatus || 'none';
            
            if (renewalStatus === 'pending' || renewalStatus === 'pending_approval') {
                status = 'renewal_pending';
            }
            
            const expiryDate = user.expiryDate || 'N√£o definida';
            const createdAt = user.createdAt ? formatDateTime(user.createdAt) : 'N√£o informada';
            const lastLogin = user.lastLogin ? formatDateTime(user.lastLogin) : 'Nunca logou';
            const phone = user.phone || 'N√£o informado';
            
            const statusText = getStatusText(status, renewalStatus);
            const statusClass = getStatusClass(status, renewalStatus);
            
            let renewalInfo = '';
            if (renewalStatus === 'pending' || renewalStatus === 'pending_approval') {
                const pendingPayment = payments.find(p => 
                    p.userId === userId && 
                    (p.status === 'pending' || p.status === 'pending_approval') &&
                    p.type === 'renewal'
                );
                
                if (pendingPayment) {
                    renewalInfo = `
                        <div class="form-group">
                            <label class="form-label" style="color: var(--info-color);">
                                <i class="fas fa-sync-alt"></i> Renova√ß√£o Pendente
                            </label>
                            <div class="form-input" style="background: #e8f4fd; border-left: 4px solid var(--info-color);">
                                <div><strong>Valor:</strong> R$ ${pendingPayment.amount?.toFixed(2).replace('.', ',') || '0,00'}</div>
                                <div><strong>Data do pedido:</strong> ${formatDateTime(pendingPayment.createdAt)}</div>
                                <div><strong>Status:</strong> ${getPaymentStatusText(pendingPayment.status)}</div>
                                ${pendingPayment.notes ? `<div><strong>Observa√ß√µes:</strong> ${pendingPayment.notes}</div>` : ''}
                            </div>
                        </div>
                    `;
                }
            }
            
            const content = `
                <div class="settings-section" style="border: none; padding: 0; box-shadow: none;">
                    ${renewalInfo}
                    
                    <div class="form-group">
                        <label class="form-label">Nome da Loja</label>
                        <div class="form-input" style="background: #f8f9fa;">${user.storeName || 'Sem nome'}</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">E-mail</label>
                        <div class="form-input" style="background: #f8f9fa;">${user.email}</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Telefone</label>
                        <div class="form-input" style="background: #f8f9fa;">${phone}</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <div class="form-input" style="background: #f8f9fa;">
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Data de Cadastro</label>
                        <div class="form-input" style="background: #f8f9fa;">${createdAt}</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">√öltimo Login</label>
                        <div class="form-input" style="background: #f8f9fa;">${lastLogin}</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Expira em</label>
                        <div class="form-input" style="background: #f8f9fa;">${expiryDate}</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Status de Renova√ß√£o</label>
                        <div class="form-input" style="background: #f8f9fa;">
                            ${renewalStatus === 'none' ? 'Nenhuma renova√ß√£o pendente' : 
                              renewalStatus === 'pending' ? 'Renova√ß√£o solicitada' :
                              renewalStatus === 'pending_approval' ? 'Aguardando aprova√ß√£o' :
                              renewalStatus === 'approved' ? 'Renova√ß√£o aprovada' :
                              renewalStatus === 'rejected' ? 'Renova√ß√£o rejeitada' : renewalStatus}
                        </div>
                    </div>
                    
                    <div class="flex gap-2 mt-2">
                        <button type="button" class="submit-btn" style="background: #757575;" id="closeDetailsBtn">
                            Fechar
                        </button>
                        ${status === 'active' || status === 'renewal_pending' ? `
                            <button type="button" class="submit-btn" style="background: var(--danger-color);" id="blockUserBtn">
                                <i class="fas fa-ban"></i> Bloquear
                            </button>
                        ` : `
                            <button type="button" class="submit-btn" style="background: var(--success-color);" id="activateUserBtn">
                                <i class="fas fa-check"></i> Ativar
                            </button>
                        `}
                    </div>
                </div>
            `;
            
            document.getElementById('userDetailsContent').innerHTML = content;
            
            document.getElementById('closeDetailsBtn')?.addEventListener('click', () => {
                userDetailsModal.style.display = 'none';
            });
            
            document.getElementById('blockUserBtn')?.addEventListener('click', () => {
                userDetailsModal.style.display = 'none';
                toggleUserStatus(userId, 'blocked');
            });
            
            document.getElementById('activateUserBtn')?.addEventListener('click', () => {
                userDetailsModal.style.display = 'none';
                toggleUserStatus(userId, 'active');
            });
            
            userDetailsModal.style.display = 'flex';
        }

        async function toggleUserStatus(userId, newStatus) {
            try {
                const user = users.find(u => u.id === userId);
                if (!user) return;
                
                const statusText = getStatusText(newStatus);
                
                let updateData = { 
                    status: newStatus,
                    updatedAt: new Date().toISOString()
                };
                
                if (newStatus === 'active') {
                    const expiryDate = new Date();
                    expiryDate.setDate(expiryDate.getDate() + 30);
                    updateData.expiryDate = expiryDate.toISOString().split('T')[0];
                    updateData.isActive = true;
                    
                } else if (newStatus === 'blocked') {
                    updateData.isActive = false;
                    // Se estiver bloqueado, cancelar qualquer renova√ß√£o pendente
                    updateData.renewalStatus = 'none';
                    
                    // Atualizar pagamentos pendentes de renova√ß√£o
                    const pendingRenewals = payments.filter(p => 
                        p.userId === userId && 
                        p.type === 'renewal' && 
                        (p.status === 'pending' || p.status === 'pending_approval')
                    );
                    
                    for (const payment of pendingRenewals) {
                        await db.collection('payments').doc(payment.id).update({
                            status: 'rejected',
                            rejectedAt: new Date().toISOString(),
                            rejectedBy: adminUser.email,
                            rejectionReason: 'Usu√°rio bloqueado'
                        });
                    }
                }
                
                await db.collection('users').doc(userId).update(updateData);
                
                const userIndex = users.findIndex(u => u.id === userId);
                if (userIndex !== -1) {
                    users[userIndex] = { ...users[userIndex], ...updateData };
                }
                
                await loadAllPayments();
                updateUsersList();
                updateStats();
                showNotification(`Usu√°rio ${statusText.toLowerCase()}!`, 'success');
                
            } catch (error) {
                console.error('Error updating user status:', error);
                showNotification('Erro ao atualizar status.', 'error');
            }
        }

        function viewPaymentDetails(paymentId) {
            const payment = payments.find(p => p.id === paymentId);
            if (!payment) return;
            
            const statusText = getPaymentStatusText(payment.status);
            const statusClass = getPaymentStatusClass(payment.status);
            const paymentType = payment.type === 'renewal' ? 'Renova√ß√£o de Plano' : 'Novo Cadastro';
            
            let receiptContent = '';
            if (payment.receiptBase64) {
                if (payment.receiptType === 'pdf') {
                    receiptContent = `
                        <div class="form-group">
                            <label class="form-label">Comprovante</label>
                            <button class="submit-btn" onclick="downloadReceipt('${payment.id}')" style="background: var(--danger-color);">
                                <i class="fas fa-file-pdf"></i> Baixar Comprovante PDF
                            </button>
                        </div>
                    `;
                } else {
                    receiptContent = `
                        <div class="form-group">
                            <label class="form-label">Comprovante <span style="color: var(--info-color); font-size: 0.8rem;">(clique para ampliar)</span></label>
                            <div class="receipt-preview-container">
                                <img src="${payment.receiptBase64}" 
                                     alt="Comprovante" 
                                     class="receipt-preview-img"
                                     onclick="openImageViewer('${payment.receiptBase64}')"
                                     style="cursor: pointer;">
                            </div>
                        </div>
                    `;
                }
            } else {
                receiptContent = `
                    <div class="form-group">
                        <label class="form-label">Comprovante</label>
                        <div class="form-input" style="background: #f8f9fa; text-align: center; color: var(--text-secondary);">
                            <i class="fas fa-file-image" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                            Sem comprovante anexado
                        </div>
                    </div>
                `;
            }
            
            let renewalInfo = '';
            if (payment.type === 'renewal') {
                renewalInfo = `
                    <div class="form-group">
                        <label class="form-label">Informa√ß√µes da Renova√ß√£o</label>
                        <div class="form-input" style="background: #f0f9ff; border-left: 4px solid var(--info-color);">
                            <div><strong>Data de vencimento original:</strong> ${formatDate(payment.originalExpiryDate)}</div>
                            <div><strong>Nova data de vencimento:</strong> ${formatDate(payment.newExpiryDate)}</div>
                            <div><strong>WhatsApp enviado:</strong> ${payment.whatsappSent ? 'Sim' : 'N√£o'}</div>
                            ${payment.notes ? `<div><strong>Observa√ß√µes:</strong> ${payment.notes}</div>` : ''}
                        </div>
                    </div>
                `;
            }
            
            const content = `
                <div class="settings-section" style="border: none; padding: 0; box-shadow: none;">
                    <div class="form-group">
                        <label class="form-label">Tipo de Pagamento</label>
                        <div class="form-input" style="background: #f8f9fa; font-weight: 600;">
                            ${paymentType}
                        </div>
                    </div>
                    
                    ${renewalInfo}
                    
                    <div class="form-group">
                        <label class="form-label">Cliente</label>
                        <div class="form-input" style="background: #f8f9fa;">${payment.userName || 'Nome n√£o informado'}</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Loja</label>
                        <div class="form-input" style="background: #f8f9fa;">${payment.storeName || 'Sem nome'}</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">E-mail</label>
                        <div class="form-input" style="background: #f8f9fa;">${payment.userEmail}</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Telefone</label>
                        <div class="form-input" style="background: #f8f9fa;">${payment.userPhone || 'N√£o informado'}</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <div class="form-input" style="background: #f8f9fa;">
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Plano</label>
                        <div class="form-input" style="background: #f8f9fa;">${payment.plan === 'monthly' ? 'Mensal' : 'Personalizado'}</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Valor</label>
                        <div class="form-input" style="background: #f8f9fa;">R$ ${payment.amount?.toFixed(2).replace('.', ',') || '0,00'}</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Data</label>
                        <div class="form-input" style="background: #f8f9fa;">${formatDateTime(payment.createdAt)}</div>
                    </div>
                    
                    ${payment.approvedAt ? `
                        <div class="form-group">
                            <label class="form-label">Aprovado em</label>
                            <div class="form-input" style="background: #f8f9fa;">${formatDateTime(payment.approvedAt)}</div>
                        </div>
                    ` : ''}
                    
                    ${payment.rejectedAt ? `
                        <div class="form-group">
                            <label class="form-label">Rejeitado em</label>
                            <div class="form-input" style="background: #f8f9fa;">${formatDateTime(payment.rejectedAt)}</div>
                        </div>
                        ${payment.rejectionReason ? `
                        <div class="form-group">
                            <label class="form-label">Motivo da rejei√ß√£o</label>
                            <div class="form-input" style="background: #f8f9fa;">${payment.rejectionReason}</div>
                        </div>
                        ` : ''}
                    ` : ''}
                    
                    ${receiptContent}
                    
                    <div class="flex gap-2 mt-2">
                        <button type="button" class="submit-btn" style="background: #757575;" id="closePaymentBtn">
                            Fechar
                        </button>
                        ${payment.status === 'pending' || payment.status === 'pending_approval' ? `
                            <button type="button" class="submit-btn" style="background: var(--success-color);" id="approvePaymentBtn">
                                <i class="fas fa-check"></i> Aprovar
                            </button>
                            <button type="button" class="submit-btn" style="background: var(--danger-color);" id="rejectPaymentBtn">
                                <i class="fas fa-times"></i> Rejeitar
                            </button>
                        ` : `
                            <button type="button" class="submit-btn" style="background: #25D366;" id="sendWhatsAppBtn">
                                <i class="fas fa-whatsapp"></i> Enviar WhatsApp
                            </button>
                            <button type="button" class="submit-btn" style="background: var(--danger-color);" id="deletePaymentBtn">
                                <i class="fas fa-trash"></i> Excluir
                            </button>
                        `}
                    </div>
                </div>
            `;
            
            document.getElementById('paymentDetailsContent').innerHTML = content;
            
            document.getElementById('closePaymentBtn')?.addEventListener('click', () => {
                paymentDetailsModal.style.display = 'none';
            });
            
            document.getElementById('approvePaymentBtn')?.addEventListener('click', async () => {
                paymentDetailsModal.style.display = 'none';
                await approvePayment(paymentId);
            });
            
            document.getElementById('rejectPaymentBtn')?.addEventListener('click', async () => {
                paymentDetailsModal.style.display = 'none';
                await rejectPayment(paymentId);
            });
            
            document.getElementById('sendWhatsAppBtn')?.addEventListener('click', async () => {
                paymentDetailsModal.style.display = 'none';
                await sendWhatsAppMessage(paymentId);
            });
            
            document.getElementById('deletePaymentBtn')?.addEventListener('click', async () => {
                paymentDetailsModal.style.display = 'none';
                showDeleteConfirmation(paymentId);
            });
            
            window.downloadReceipt = function(id) {
                const p = payments.find(p => p.id === id);
                if (p && p.receiptBase64) {
                    const link = document.createElement('a');
                    link.href = p.receiptBase64;
                    link.download = p.receiptFileName || 'comprovante.pdf';
                    link.click();
                }
            };
            
            paymentDetailsModal.style.display = 'flex';
        }

        async function approvePayment(paymentId) {
            try {
                const payment = payments.find(p => p.id === paymentId);
                if (!payment) return;
                
                const userId = payment.userId;
                const user = users.find(u => u.id === userId);
                
                // Calcular nova data de vencimento
                let newExpiryDate = new Date();
                let planDays = 30;
                
                if (payment.plan === 'custom' && payment.planDays) {
                    planDays = parseInt(payment.planDays) || 30;
                }
                
                // Se for uma renova√ß√£o e o usu√°rio j√° tem uma data de vencimento,
                // adicionamos os dias AP√ìS a data atual de vencimento
                if (payment.type === 'renewal' && user && user.expiryDate) {
                    const currentExpiry = new Date(user.expiryDate);
                    // S√≥ renova se a data atual for depois ou pr√≥xima do vencimento
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    if (currentExpiry > today) {
                        // Ainda n√£o venceu, renova a partir da data de vencimento
                        newExpiryDate = new Date(currentExpiry);
                    }
                }
                
                newExpiryDate.setDate(newExpiryDate.getDate() + planDays);
                const expiryDateStr = newExpiryDate.toISOString().split('T')[0];
                
                // Atualizar pagamento
                await db.collection('payments').doc(paymentId).update({
                    status: 'approved',
                    approvedAt: new Date().toISOString(),
                    approvedBy: adminUser.email,
                    newExpiryDate: expiryDateStr
                });
                
                // Atualizar usu√°rio
                const updateData = {
                    status: 'active',
                    isActive: true,
                    expiryDate: expiryDateStr,
                    renewalStatus: 'approved',
                    lastRenewalDate: new Date().toISOString(),
                    paymentConfirmed: true,
                    lastPaymentDate: new Date().toISOString()
                };
                
                // Se for um novo cadastro, definir o plano
                if (payment.type !== 'renewal') {
                    updateData.plan = payment.plan || 'monthly';
                    updateData.planDays = payment.planDays || 30;
                }
                
                await db.collection('users').doc(userId).update(updateData);
                
                // Enviar WhatsApp de confirma√ß√£o
                await sendApprovalWhatsApp(payment, expiryDateStr);
                
                showNotification('Pagamento aprovado! Usu√°rio ativado.', 'success');
                
                await loadAllUsers();
                await loadAllPayments();
                
            } catch (error) {
                console.error('Error approving payment:', error);
                showNotification('Erro ao aprovar pagamento.', 'error');
            }
        }

        async function sendApprovalWhatsApp(payment, expiryDateStr) {
            try {
                const userPhone = payment.userPhone;
                if (!userPhone) {
                    console.log('Telefone do cliente n√£o informado para WhatsApp');
                    return;
                }
                
                const cleanPhone = userPhone.replace(/\D/g, '');
                if (cleanPhone.length < 10) {
                    console.log('N√∫mero de telefone inv√°lido para WhatsApp');
                    return;
                }
                
                const messageTemplate = systemConfig.paymentApprovedMessage || '';
                if (!messageTemplate) {
                    console.log('Mensagem de aprova√ß√£o n√£o configurada');
                    return;
                }
                
                const formattedDate = new Date().toLocaleDateString('pt-BR');
                const formattedExpiryDate = new Date(expiryDateStr).toLocaleDateString('pt-BR');
                
                let finalMessage = messageTemplate
                    .replace(/{nome}/g, payment.userName || 'Cliente')
                    .replace(/{loja}/g, payment.storeName || '')
                    .replace(/{plano}/g, payment.plan === 'monthly' ? 'Mensal' : 'Personalizado')
                    .replace(/{valor}/g, payment.amount?.toFixed(2).replace('.', ',') || '0,00')
                    .replace(/{data}/g, formattedDate)
                    .replace(/{validade}/g, formattedExpiryDate)
                    .replace(/{email}/g, payment.userEmail || '')
                    .replace(/{telefone}/g, payment.userPhone || '');
                
                const encodedMessage = encodeURIComponent(finalMessage);
                const whatsappUrl = `https://wa.me/55${cleanPhone}?text=${encodedMessage}`;
                
                const link = document.createElement('a');
                link.href = whatsappUrl;
                link.target = '_blank';
                link.rel = 'noopener noreferrer';
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                
                setTimeout(() => {
                    document.body.removeChild(link);
                }, 100);
                
                // Marcar como enviado no banco de dados
                await db.collection('payments').doc(payment.id).update({
                    whatsappSent: true,
                    whatsappSentAt: new Date().toISOString(),
                    whatsappSentBy: adminUser.email
                });
                
            } catch (error) {
                console.error('Error sending approval WhatsApp:', error);
            }
        }

        async function rejectPayment(paymentId) {
            try {
                const payment = payments.find(p => p.id === paymentId);
                if (!payment) return;
                
                const rejectionReason = prompt('Digite o motivo da rejei√ß√£o:');
                if (!rejectionReason) {
                    showNotification('Opera√ß√£o cancelada. Motivo n√£o informado.', 'warning');
                    return;
                }
                
                await db.collection('payments').doc(paymentId).update({
                    status: 'rejected',
                    rejectedAt: new Date().toISOString(),
                    rejectedBy: adminUser.email,
                    rejectionReason: rejectionReason
                });
                
                // Se for uma renova√ß√£o, atualizar status do usu√°rio
                if (payment.type === 'renewal') {
                    await db.collection('users').doc(payment.userId).update({
                        renewalStatus: 'rejected',
                        lastRenewalResponse: new Date().toISOString()
                    });
                }
                
                showNotification('Pagamento rejeitado!', 'warning');
                await loadAllPayments();
                await loadAllUsers();
                
            } catch (error) {
                console.error('Error rejecting payment:', error);
                showNotification('Erro ao rejeitar pagamento.', 'error');
            }
        }

        async function sendWhatsAppMessage(paymentId) {
            try {
                const payment = payments.find(p => p.id === paymentId);
                if (!payment) return;
                
                const userPhone = payment.userPhone;
                if (!userPhone) {
                    showNotification('Telefone do cliente n√£o informado.', 'error');
                    return;
                }
                
                const cleanPhone = userPhone.replace(/\D/g, '');
                if (cleanPhone.length < 10) {
                    showNotification('N√∫mero de telefone inv√°lido.', 'error');
                    return;
                }
                
                let messageTemplate = '';
                let messageType = '';
                
                if (payment.status === 'approved') {
                    messageTemplate = systemConfig.paymentApprovedMessage || '';
                    messageType = 'aprovado';
                } else if (payment.status === 'rejected') {
                    messageTemplate = systemConfig.paymentRejectedMessage || '';
                    messageType = 'rejeitado';
                } else {
                    showNotification('S√≥ √© poss√≠vel enviar WhatsApp para pagamentos aprovados ou rejeitados.', 'warning');
                    return;
                }
                
                if (!messageTemplate) {
                    showNotification(`Mensagem de ${messageType} n√£o configurada.`, 'error');
                    return;
                }
                
                const user = users.find(u => u.id === payment.userId);
                const paymentDate = new Date(payment.createdAt);
                const formattedDate = paymentDate.toLocaleDateString('pt-BR');
                
                let expiryDate = '';
                if (payment.status === 'approved' && user) {
                    expiryDate = user.expiryDate || '';
                    if (expiryDate) {
                        const expiryDateObj = new Date(expiryDate);
                        expiryDate = expiryDateObj.toLocaleDateString('pt-BR');
                    }
                }
                
                let finalMessage = messageTemplate
                    .replace(/{nome}/g, payment.userName || 'Cliente')
                    .replace(/{loja}/g, payment.storeName || '')
                    .replace(/{plano}/g, payment.plan === 'monthly' ? 'Mensal' : 'Personalizado')
                    .replace(/{valor}/g, payment.amount?.toFixed(2).replace('.', ',') || '0,00')
                    .replace(/{data}/g, formattedDate)
                    .replace(/{validade}/g, expiryDate)
                    .replace(/{email}/g, payment.userEmail || '')
                    .replace(/{telefone}/g, payment.userPhone || '');
                
                const encodedMessage = encodeURIComponent(finalMessage);
                const whatsappUrl = `https://wa.me/55${cleanPhone}?text=${encodedMessage}`;
                
                const link = document.createElement('a');
                link.href = whatsappUrl;
                link.target = '_blank';
                link.rel = 'noopener noreferrer';
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                
                setTimeout(() => {
                    document.body.removeChild(link);
                }, 100);
                
                showNotification(`WhatsApp enviado! Status: ${messageType}`, 'success');
                
                await db.collection('payments').doc(paymentId).update({
                    whatsappSent: true,
                    whatsappSentAt: new Date().toISOString(),
                    whatsappSentBy: adminUser.email
                });
                
            } catch (error) {
                console.error('Error sending WhatsApp:', error);
                showNotification('Erro ao enviar WhatsApp.', 'error');
            }
        }

        function showDeleteConfirmation(paymentId) {
            currentPaymentToDelete = paymentId;
            deleteConfirmationModal.style.display = 'flex';
            setTimeout(() => {
                confirmationInput.focus();
            }, 300);
        }

        async function deletePayment() {
            if (!currentPaymentToDelete) return;
            
            try {
                await db.collection('payments').doc(currentPaymentToDelete).delete();
                
                const paymentIndex = payments.findIndex(p => p.id === currentPaymentToDelete);
                if (paymentIndex !== -1) {
                    payments.splice(paymentIndex, 1);
                }
                
                deleteConfirmationModal.style.display = 'none';
                resetDeleteConfirmation();
                
                updatePaymentsList();
                showNotification('Pagamento exclu√≠do com sucesso!', 'success');
                
            } catch (error) {
                console.error('Error deleting payment:', error);
                showNotification('Erro ao excluir pagamento.', 'error');
            }
        }

        async function createNewUser(e) {
            e.preventDefault();
            
            const storeName = document.getElementById('newStoreName').value;
            const email = document.getElementById('newUserEmail').value;
            const password = document.getElementById('newUserPassword').value;
            const phone = document.getElementById('newUserPhone').value;
            const status = document.getElementById('newUserStatus').value;
            const plan = document.getElementById('newUserPlan').value;
            const customDays = plan === 'custom' ? parseInt(document.getElementById('customPlanDays').value) || 30 : 30;
            
            if (!phone || phone.replace(/\D/g, '').length < 11) {
                showNotification('Informe um n√∫mero de WhatsApp v√°lido.', 'error');
                return;
            }
            
            if (plan === 'custom' && (customDays < 1 || customDays > 365)) {
                showNotification('Os dias do plano personalizado devem estar entre 1 e 365.', 'error');
                return;
            }
            
            try {
                showLoading();
                
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                let expiryDate = '';
                if (status === 'active') {
                    const date = new Date();
                    date.setDate(date.getDate() + customDays);
                    expiryDate = date.toISOString().split('T')[0];
                }
                
                await db.collection('users').doc(user.uid).set({
                    uid: user.uid,
                    email: user.email,
                    storeName: storeName,
                    phone: phone,
                    status: status,
                    plan: plan,
                    planDays: customDays,
                    expiryDate: expiryDate,
                    isActive: status === 'active',
                    configCompleted: false,
                    renewalStatus: 'none',
                    createdAt: new Date().toISOString(),
                    createdBy: adminUser.email,
                    lastActivity: new Date().toISOString()
                });
                
                closeNewUser();
                await loadAllUsers();
                showNotification('Usu√°rio criado com sucesso!', 'success');
                hideLoading();
                
            } catch (error) {
                console.error('Error creating user:', error);
                let errorMessage = 'Erro ao criar usu√°rio.';
                
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Este e-mail j√° est√° em uso.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'E-mail inv√°lido.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Senha muito fraca. Use pelo menos 6 caracteres.';
                }
                
                showNotification(errorMessage, 'error');
                hideLoading();
            }
        }

        async function saveSystemConfig(e) {
            e.preventDefault();
            
            const configData = {
                pixKey: pixKeyInput.value,
                adminWhatsApp: adminWhatsAppInput.value,
                monthlyPlanPrice: parseFloat(monthlyPlanPriceInput.value) || 99.00,
                expirationWarningDays: parseInt(expirationWarningDaysInput.value) || 7,
                whatsappMessage: whatsappMessageInput.value,
                paymentApprovedMessage: paymentApprovedMessageInput.value,
                paymentRejectedMessage: paymentRejectedMessageInput.value,
                updatedAt: new Date().toISOString(),
                updatedBy: adminUser.email
            };
            
            try {
                await db.collection('systemConfig').doc('paymentSettings').set(configData, { merge: true });
                systemConfig = configData;
                showNotification('Configura√ß√µes salvas!', 'success');
            } catch (error) {
                console.error('Error saving system config:', error);
                showNotification('Erro ao salvar configura√ß√µes.', 'error');
            }
        }

        function clearCache() {
            localStorage.removeItem('adminSession');
            showNotification('Cache limpo! A p√°gina ser√° recarregada.', 'info');
            setTimeout(() => {
                location.reload();
            }, 1500);
        }

        function showNotification(message, type = 'info', duration = 3000) {
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => {
                notification.remove();
            });
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, duration);
        }

        function showLoading() {
            loadingOverlay.style.display = 'flex';
        }

        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }

        function formatDate(dateString) {
            if (!dateString) return 'Data n√£o informada';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('pt-BR');
            } catch (error) {
                return 'Data inv√°lida';
            }
        }
        
        function formatDateTime(dateString) {
            if (!dateString) return 'Data/hora n√£o informada';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            } catch (error) {
                return 'Data inv√°lida';
            }
        }
        
        function getStatusText(status, renewalStatus = 'none') {
            if (status === 'renewal_pending') {
                return renewalStatus === 'pending_approval' ? 'Aguardando Aprova√ß√£o' : 'Renova√ß√£o Pendente';
            }
            
            switch(status) {
                case 'active': return 'Ativo';
                case 'pending': return 'Pendente';
                case 'blocked': return 'Bloqueado';
                case 'expired': return 'Expirado';
                default: return 'Desconhecido';
            }
        }
        
        function getStatusClass(status, renewalStatus = 'none') {
            if (status === 'renewal_pending') {
                return 'status-renewal-pending';
            }
            
            switch(status) {
                case 'active': return 'status-active';
                case 'pending': return 'status-pending';
                case 'blocked': return 'status-blocked';
                case 'expired': return 'status-expired';
                default: return 'status-pending';
            }
        }
        
        function getPaymentStatusText(status) {
            switch(status) {
                case 'pending': return 'Pendente';
                case 'pending_approval': return 'Aguardando Aprova√ß√£o';
                case 'approved': return 'Aprovado';
                case 'rejected': return 'Rejeitado';
                default: return 'Desconhecido';
            }
        }
        
        function getPaymentStatusClass(status) {
            switch(status) {
                case 'pending': 
                case 'pending_approval': 
                    return 'status-pending';
                case 'approved': return 'status-approved';
                case 'rejected': return 'status-rejected';
                default: return 'status-pending';
            }
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>